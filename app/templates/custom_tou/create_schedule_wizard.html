{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('custom_tou.index') }}">Custom TOU</a></li>
            <li class="breadcrumb-item active" aria-current="page">Create Schedule</li>
        </ol>
    </nav>

    <h2>âš¡ Create Custom TOU Schedule</h2>
    <p class="text-muted">Follow the steps below to create your custom time-of-use rate plan. All on one page!</p>

    <form id="wizard-form" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" id="seasons-data" name="seasons_data" value="">

        <!-- STEP 1: Provider & Rate Plan -->
        <div class="card mb-3 wizard-step" id="step-1">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <span class="step-number">1</span> Utility Provider & Rate Plan
                    <span class="badge bg-light text-dark float-end step-status" id="status-1">Required</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Utility Provider *</label>
                        <input type="text" class="form-control" id="utility" name="utility"
                               placeholder="e.g., Origin Energy" required
                               list="utility-presets">
                        <datalist id="utility-presets">
                            <option value="Origin Energy">
                            <option value="AGL">
                            <option value="Energy Australia">
                            <option value="Ausgrid">
                            <option value="Energex">
                            <option value="Essential Energy">
                            <option value="Endeavour Energy">
                            <option value="Evoenergy">
                        </datalist>
                        <small class="text-muted">Your electricity provider</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Rate Plan Name *</label>
                        <input type="text" class="form-control" id="name" name="name"
                               placeholder="e.g., Single Rate + TOU" required>
                        <small class="text-muted">Name of your plan</small>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Tariff Code (Optional)</label>
                        <input type="text" class="form-control" id="code" name="code"
                               placeholder="e.g., EA205">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Daily Supply Charge ($)</label>
                        <input type="number" class="form-control" id="daily_charge" name="daily_charge"
                               step="0.0001" value="0" placeholder="1.1770">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Monthly Charge ($)</label>
                        <input type="number" class="form-control" id="monthly_charge" name="monthly_charge"
                               step="0.01" value="0" placeholder="0.00">
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: Seasons -->
        <div class="card mb-3 wizard-step" id="step-2">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <span class="step-number">2</span> Add Seasons
                    <span class="badge bg-light text-dark float-end step-status" id="status-2">Add at least 1</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Most tariffs use "All Year" as a single season. Some have Summer/Winter rates.</p>

                <div id="seasons-container"></div>

                <button type="button" class="btn btn-outline-info btn-sm" onclick="addSeason()">
                    + Add Season
                </button>
            </div>
        </div>

        <!-- STEP 3: Time Periods -->
        <div class="card mb-3 wizard-step" id="step-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <span class="step-number">3</span> Add Time Periods
                    <span class="badge bg-light text-dark float-end step-status" id="status-3">Add periods to each season</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Define the time periods and rates for each season. Common examples: Peak, Shoulder, Off-Peak.</p>
                <div id="all-periods-container"></div>
            </div>
        </div>

        <!-- STEP 4: Preview & Save -->
        <div class="card mb-4 wizard-step" id="step-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <span class="step-number">4</span> Preview & Save
                </h5>
            </div>
            <div class="card-body">
                <div id="preview-content">
                    <p class="text-muted">Complete the steps above to see a preview</p>
                </div>

                <div class="form-check mb-3">
                    <input type="checkbox" name="set_active" class="form-check-input" id="setActive">
                    <label class="form-check-label" for="setActive">
                        <strong>Set as Active Schedule</strong> (will be synced to Tesla)
                    </label>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('custom_tou.index') }}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                        ðŸ’¾ Save Schedule
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.wizard-step {
    border-left: 4px solid #dee2e6;
    transition: all 0.3s ease;
}
.wizard-step:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.step-number {
    display: inline-block;
    width: 30px;
    height: 30px;
    line-height: 30px;
    text-align: center;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    margin-right: 10px;
}
.season-card {
    border: 2px solid #0dcaf0;
    margin-bottom: 15px;
}
.period-row {
    background: #f8f9fa;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
    border-left: 3px solid #198754;
}
.preset-btn {
    font-size: 0.85rem;
    padding: 2px 8px;
}
</style>

<script>
let seasons = [];
let seasonCounter = 0;

// Common presets
const seasonPresets = ['All Year', 'Summer', 'Winter', 'Spring', 'Autumn'];
const periodPresets = ['Peak', 'Shoulder', 'Off-Peak', 'Super Off-Peak', 'Weekend', 'Weekday'];
const timePresets = [
    {label: '00:00-07:00', from_h: 0, from_m: 0, to_h: 7, to_m: 0},
    {label: '07:00-14:00', from_h: 7, from_m: 0, to_h: 14, to_m: 0},
    {label: '14:00-20:00', from_h: 14, from_m: 0, to_h: 20, to_m: 0},
    {label: '20:00-00:00', from_h: 20, from_m: 0, to_h: 0, to_m: 0},
    {label: '00:00-00:00 (All Day)', from_h: 0, from_m: 0, to_h: 0, to_m: 0},
];

function addSeason() {
    const id = seasonCounter++;
    seasons.push({
        id: id,
        name: '',
        from_month: 1,
        from_day: 1,
        to_month: 12,
        to_day: 31,
        periods: []
    });
    renderSeasons();
    updatePreview();
}

function removeSeason(id) {
    seasons = seasons.filter(s => s.id !== id);
    renderSeasons();
    updatePreview();
}

function addPeriod(seasonId) {
    const season = seasons.find(s => s.id === seasonId);
    if (!season) return;

    season.periods.push({
        id: Date.now(),
        name: '',
        from_hour: 0,
        from_minute: 0,
        to_hour: 0,
        to_minute: 0,
        from_day_of_week: 0,
        to_day_of_week: 6,
        energy_rate: 0.25,
        sell_rate: 0.05,
        demand_rate: 0
    });
    renderSeasons();
    updatePreview();
}

function removePeriod(seasonId, periodId) {
    const season = seasons.find(s => s.id === seasonId);
    if (!season) return;
    season.periods = season.periods.filter(p => p.id !== periodId);
    renderSeasons();
    updatePreview();
}

function applySeasonPreset(seasonId, presetName) {
    const season = seasons.find(s => s.id === seasonId);
    if (!season) return;

    season.name = presetName;

    // Apply date ranges for common presets
    if (presetName === 'All Year') {
        season.from_month = 1; season.from_day = 1;
        season.to_month = 12; season.to_day = 31;
    } else if (presetName === 'Summer') {
        season.from_month = 12; season.from_day = 1;
        season.to_month = 2; season.to_day = 28;
    } else if (presetName === 'Winter') {
        season.from_month = 6; season.from_day = 1;
        season.to_month = 8; season.to_day = 31;
    } else if (presetName === 'Spring') {
        season.from_month = 9; season.from_day = 1;
        season.to_month = 11; season.to_day = 30;
    } else if (presetName === 'Autumn') {
        season.from_month = 3; season.from_day = 1;
        season.to_month = 5; season.to_day = 31;
    }

    renderSeasons();
    updatePreview();
}

function applyTimePreset(seasonId, periodId, preset) {
    const season = seasons.find(s => s.id === seasonId);
    if (!season) return;
    const period = season.periods.find(p => p.id === periodId);
    if (!period) return;

    period.from_hour = preset.from_h;
    period.from_minute = preset.from_m;
    period.to_hour = preset.to_h;
    period.to_minute = preset.to_m;

    renderSeasons();
    updatePreview();
}

function renderSeasons() {
    const container = document.getElementById('seasons-container');
    const periodsContainer = document.getElementById('all-periods-container');

    if (seasons.length === 0) {
        container.innerHTML = '<p class="text-muted">No seasons added yet. Click "Add Season" to get started.</p>';
        periodsContainer.innerHTML = '<p class="text-muted">Add seasons first, then add time periods for each season.</p>';
        document.getElementById('status-2').textContent = 'Add at least 1';
        document.getElementById('status-2').className = 'badge bg-light text-dark float-end step-status';
        return;
    }

    // Render season cards
    container.innerHTML = seasons.map(season => `
        <div class="season-card card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">Season ${seasons.indexOf(season) + 1}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSeason(${season.id})">Remove</button>
                </div>

                <div class="mb-2">
                    <label class="form-label">Season Name *</label>
                    <input type="text" class="form-control form-control-sm"
                           value="${season.name}"
                           oninput="seasons.find(s => s.id === ${season.id}).name = this.value; updatePreview();"
                           placeholder="e.g., All Year">
                    <div class="mt-1">
                        ${seasonPresets.map(p => `<button type="button" class="btn btn-outline-secondary preset-btn me-1" onclick="applySeasonPreset(${season.id}, '${p}')">${p}</button>`).join('')}
                    </div>
                </div>

                <div class="row">
                    <div class="col-6">
                        <label class="form-label">From Date</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" value="${season.from_day}" min="1" max="31"
                                   oninput="seasons.find(s => s.id === ${season.id}).from_day = parseInt(this.value); updatePreview();" placeholder="Day">
                            <span class="input-group-text">/</span>
                            <input type="number" class="form-control" value="${season.from_month}" min="1" max="12"
                                   oninput="seasons.find(s => s.id === ${season.id}).from_month = parseInt(this.value); updatePreview();" placeholder="Month">
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label">To Date</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" value="${season.to_day}" min="1" max="31"
                                   oninput="seasons.find(s => s.id === ${season.id}).to_day = parseInt(this.value); updatePreview();" placeholder="Day">
                            <span class="input-group-text">/</span>
                            <input type="number" class="form-control" value="${season.to_month}" min="1" max="12"
                                   oninput="seasons.find(s => s.id === ${season.id}).to_month = parseInt(this.value); updatePreview();" placeholder="Month">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    // Render periods for each season
    periodsContainer.innerHTML = seasons.map(season => `
        <div class="mb-4">
            <h6><strong>${season.name || 'Season ' + (seasons.indexOf(season) + 1)}</strong> - Time Periods</h6>
            ${season.periods.length === 0 ? '<p class="text-muted small">No periods added yet</p>' : ''}
            ${season.periods.map(period => renderPeriodRow(season.id, period)).join('')}
            <button type="button" class="btn btn-success btn-sm" onclick="addPeriod(${season.id})">
                + Add Period
            </button>
        </div>
    `).join('');

    document.getElementById('status-2').textContent = `${seasons.length} season(s) added`;
    document.getElementById('status-2').className = 'badge bg-success float-end step-status';

    const totalPeriods = seasons.reduce((sum, s) => sum + s.periods.length, 0);
    document.getElementById('status-3').textContent = totalPeriods > 0 ? `${totalPeriods} period(s) added` : 'Add periods to each season';
    document.getElementById('status-3').className = totalPeriods > 0 ? 'badge bg-success float-end step-status' : 'badge bg-light text-dark float-end step-status';
}

function renderPeriodRow(seasonId, period) {
    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    return `
        <div class="period-row">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <strong>${period.name || 'Period'}</strong>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePeriod(${seasonId}, ${period.id})">Remove</button>
            </div>

            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label small">Period Name *</label>
                    <input type="text" class="form-control form-control-sm" value="${period.name}"
                           oninput="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).name = this.value; updatePreview();"
                           list="period-presets-${period.id}" placeholder="e.g., Peak">
                    <datalist id="period-presets-${period.id}">
                        ${periodPresets.map(p => `<option value="${p}">`).join('')}
                    </datalist>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Time Range</label>
                    <div class="input-group input-group-sm mb-1">
                        <input type="number" class="form-control" value="${period.from_hour}" min="0" max="23" style="max-width:45px"
                               oninput="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).from_hour = parseInt(this.value); updatePreview();">
                        <span class="input-group-text">:</span>
                        <select class="form-select" style="max-width:55px"
                                onchange="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).from_minute = parseInt(this.value); updatePreview();">
                            <option value="0" ${period.from_minute === 0 ? 'selected' : ''}>00</option>
                            <option value="30" ${period.from_minute === 30 ? 'selected' : ''}>30</option>
                        </select>
                        <span class="input-group-text">to</span>
                        <input type="number" class="form-control" value="${period.to_hour}" min="0" max="23" style="max-width:45px"
                               oninput="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).to_hour = parseInt(this.value); updatePreview();">
                        <span class="input-group-text">:</span>
                        <select class="form-select" style="max-width:55px"
                                onchange="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).to_minute = parseInt(this.value); updatePreview();">
                            <option value="0" ${period.to_minute === 0 ? 'selected' : ''}>00</option>
                            <option value="30" ${period.to_minute === 30 ? 'selected' : ''}>30</option>
                        </select>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        ${timePresets.map(preset => `
                            <button type="button" class="btn btn-outline-secondary" style="font-size:0.7rem; padding: 2px 4px;"
                                    onclick='applyTimePreset(${seasonId}, ${period.id}, ${JSON.stringify(preset).replace(/'/g, "\\'")})'>
                                ${preset.label.split(' ')[0]}
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Days</label>
                    <div class="input-group input-group-sm">
                        <select class="form-select"
                                onchange="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).from_day_of_week = parseInt(this.value); updatePreview();">
                            ${dayNames.map((day, i) => `<option value="${i}" ${period.from_day_of_week === i ? 'selected' : ''}>${day}</option>`).join('')}
                        </select>
                        <span class="input-group-text">to</span>
                        <select class="form-select"
                                onchange="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).to_day_of_week = parseInt(this.value); updatePreview();">
                            ${dayNames.map((day, i) => `<option value="${i}" ${period.to_day_of_week === i ? 'selected' : ''}>${day}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mt-1">
                        <button type="button" class="btn btn-outline-secondary preset-btn"
                                onclick="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).from_day_of_week = 0; seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).to_day_of_week = 4; renderSeasons(); updatePreview();">Weekdays</button>
                        <button type="button" class="btn btn-outline-secondary preset-btn"
                                onclick="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).from_day_of_week = 5; seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).to_day_of_week = 6; renderSeasons(); updatePreview();">Weekend</button>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Rates ($/kWh)</label>
                    <div class="input-group input-group-sm mb-1">
                        <span class="input-group-text">Buy</span>
                        <input type="number" class="form-control" value="${period.energy_rate}" step="0.0001" min="0"
                               oninput="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).energy_rate = parseFloat(this.value); updatePreview();">
                    </div>
                    <div class="input-group input-group-sm mb-1">
                        <span class="input-group-text">Sell</span>
                        <input type="number" class="form-control" value="${period.sell_rate}" step="0.0001" min="0"
                               oninput="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).sell_rate = parseFloat(this.value); updatePreview();">
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">Demand</span>
                        <input type="number" class="form-control" value="${period.demand_rate}" step="0.0001" min="0"
                               oninput="seasons.find(s => s.id === ${seasonId}).periods.find(p => p.id === ${period.id}).demand_rate = parseFloat(this.value); updatePreview();">
                    </div>
                </div>
            </div>
        </div>
    `;
}

function updatePreview() {
    const utility = document.getElementById('utility').value || 'Your Provider';
    const name = document.getElementById('name').value || 'Your Plan';
    const code = document.getElementById('code').value;
    const dailyCharge = document.getElementById('daily_charge').value || '0';
    const monthlyCharge = document.getElementById('monthly_charge').value || '0';

    const totalPeriods = seasons.reduce((sum, s) => sum + s.periods.length, 0);

    document.getElementById('preview-content').innerHTML = `
        <h6>Your Schedule Summary:</h6>
        <dl class="row mb-0">
            <dt class="col-sm-3">Provider:</dt>
            <dd class="col-sm-9"><strong>${utility}</strong></dd>

            <dt class="col-sm-3">Plan:</dt>
            <dd class="col-sm-9"><strong>${name}</strong> ${code ? '(' + code + ')' : ''}</dd>

            <dt class="col-sm-3">Daily Charge:</dt>
            <dd class="col-sm-9">$${parseFloat(dailyCharge).toFixed(4)}</dd>

            ${parseFloat(monthlyCharge) > 0 ? `
            <dt class="col-sm-3">Monthly Charge:</dt>
            <dd class="col-sm-9">$${parseFloat(monthlyCharge).toFixed(2)}</dd>
            ` : ''}

            <dt class="col-sm-3">Seasons:</dt>
            <dd class="col-sm-9">${seasons.length} season(s)</dd>

            <dt class="col-sm-3">Time Periods:</dt>
            <dd class="col-sm-9">${totalPeriods} period(s) total</dd>
        </dl>

        ${seasons.length > 0 && totalPeriods > 0 ? '<div class="alert alert-success mb-0 mt-3">âœ“ Ready to save!</div>' : '<div class="alert alert-warning mb-0 mt-3">âš  Add seasons and time periods to complete your schedule</div>'}
    `;

    // Update hidden field with JSON data
    document.getElementById('seasons-data').value = JSON.stringify(seasons);

    // Enable/disable submit button
    const isValid = utility && name && seasons.length > 0 && totalPeriods > 0;
    document.getElementById('submit-btn').disabled = !isValid;
}

// Initialize with one season
document.addEventListener('DOMContentLoaded', function() {
    addSeason();

    // Update preview on form field changes
    ['utility', 'name', 'code', 'daily_charge', 'monthly_charge'].forEach(fieldId => {
        document.getElementById(fieldId).addEventListener('input', updatePreview);
    });

    // Mark step 1 as complete when fields are filled
    document.getElementById('utility').addEventListener('input', function() {
        const isComplete = document.getElementById('utility').value && document.getElementById('name').value;
        document.getElementById('status-1').textContent = isComplete ? 'âœ“ Complete' : 'Required';
        document.getElementById('status-1').className = isComplete ? 'badge bg-success float-end step-status' : 'badge bg-light text-dark float-end step-status';
    });
    document.getElementById('name').addEventListener('input', function() {
        const isComplete = document.getElementById('utility').value && document.getElementById('name').value;
        document.getElementById('status-1').textContent = isComplete ? 'âœ“ Complete' : 'Required';
        document.getElementById('status-1').className = isComplete ? 'badge bg-success float-end step-status' : 'badge bg-light text-dark float-end step-status';
    });
});
</script>
{% endblock %}
