{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('custom_tou.index') }}">Custom TOU</a></li>
            <li class="breadcrumb-item active" aria-current="page">Create Schedule</li>
        </ol>
    </nav>

    <h2><i class="bi bi-calendar-plus"></i> Create Custom TOU Schedule</h2>
    <p class="text-muted">Define your electricity provider's rate plan with unlimited time periods and 30-minute granularity.</p>

    <form method="POST" class="mt-4">
        {{ form.hidden_tag() }}

        <!-- Utility Provider & Rate Plan Section -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-building"></i> Utility Provider & Rate Plan</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    <i class="bi bi-info-circle"></i>
                    These settings will appear in your Tesla app exactly as entered. Choose names that match your electricity bill.
                </p>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.utility.label(class="form-label fw-bold") }}
                        {{ form.utility(class="form-control form-control-lg", placeholder="e.g., Origin Energy") }}
                        {% if form.utility.description %}
                        <small class="form-text text-muted">{{ form.utility.description }}</small>
                        {% endif %}
                        {% if form.utility.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.utility.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        {{ form.name.label(class="form-label fw-bold") }}
                        {{ form.name(class="form-control form-control-lg", placeholder="e.g., Single Rate + TOU") }}
                        {% if form.name.description %}
                        <small class="form-text text-muted">{{ form.name.description }}</small>
                        {% endif %}
                        {% if form.name.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.name.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3">
                    {{ form.code.label(class="form-label") }}
                    {{ form.code(class="form-control", placeholder="e.g., EA205") }}
                    {% if form.code.description %}
                    <small class="form-text text-muted">{{ form.code.description }}</small>
                    {% endif %}
                </div>

                <div class="alert alert-info mb-0">
                    <strong><i class="bi bi-lightbulb"></i> Tesla App Display:</strong><br>
                    In the Tesla app, your rate plan will show as:<br>
                    <span class="badge bg-secondary mt-2">Utility: <span id="preview-utility">Your Provider</span></span>
                    <span class="badge bg-secondary mt-2">Plan: <span id="preview-plan">Your Plan Name</span></span>
                    {% if form.code.data %}<span class="badge bg-secondary mt-2">Code: <span id="preview-code">Code</span></span>{% endif %}
                </div>
            </div>
        </div>

        <!-- Charges Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Fixed Charges</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Enter any fixed daily or monthly charges from your electricity bill.
                </p>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.daily_charge.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.daily_charge(class="form-control", placeholder="1.1770", step="0.0001") }}
                            <span class="input-group-text">/day</span>
                        </div>
                        {% if form.daily_charge.description %}
                        <small class="form-text text-muted">{{ form.daily_charge.description }}</small>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        {{ form.monthly_charge.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.monthly_charge(class="form-control", placeholder="0.00", step="0.01") }}
                            <span class="input-group-text">/month</span>
                        </div>
                        {% if form.monthly_charge.description %}
                        <small class="form-text text-muted">{{ form.monthly_charge.description }}</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Status Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Schedule Status</h5>
            </div>
            <div class="card-body">
                <div class="form-check">
                    <input type="checkbox" name="set_active" class="form-check-input" id="setActive">
                    <label class="form-check-label" for="setActive">
                        <strong>Set as Active Schedule</strong>
                    </label>
                    <small class="form-text text-muted d-block">
                        Only one schedule can be active at a time. The active schedule is the one that will be synced to your Tesla Powerwall.
                    </small>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between mb-4">
            <a href="{{ url_for('custom_tou.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Cancel
            </a>
            {{ form.submit(class="btn btn-primary btn-lg") }}
        </div>

        <div class="alert alert-warning">
            <h6><i class="bi bi-exclamation-triangle"></i> Next Steps</h6>
            <p class="mb-0">
                After creating this schedule, you'll need to:
            </p>
            <ol class="mb-0 mt-2">
                <li>Add at least one <strong>Season</strong> (e.g., "All Year", "Summer", "Winter")</li>
                <li>For each season, add <strong>Time Periods</strong> with your electricity rates</li>
                <li><strong>Preview</strong> the generated Tesla tariff</li>
                <li><strong>Sync to Tesla</strong> to upload the rates to your Powerwall</li>
            </ol>
        </div>
    </form>
</div>

<style>
.card {
    border-left: 4px solid #dee2e6;
    transition: all 0.3s ease;
}
.card:hover {
    border-left-color: #0d6efd;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.card-header.bg-primary {
    border-left: 4px solid #0a58ca;
}
</style>

<script>
// Live preview of utility and plan name
document.addEventListener('DOMContentLoaded', function() {
    const utilityInput = document.getElementById('utility');
    const nameInput = document.getElementById('name');
    const codeInput = document.getElementById('code');

    const previewUtility = document.getElementById('preview-utility');
    const previewPlan = document.getElementById('preview-plan');
    const previewCode = document.getElementById('preview-code');

    if (utilityInput && previewUtility) {
        utilityInput.addEventListener('input', function() {
            previewUtility.textContent = this.value || 'Your Provider';
        });
    }

    if (nameInput && previewPlan) {
        nameInput.addEventListener('input', function() {
            previewPlan.textContent = this.value || 'Your Plan Name';
        });
    }

    if (codeInput && previewCode) {
        codeInput.addEventListener('input', function() {
            previewCode.textContent = this.value || 'Code';
            if (this.value) {
                previewCode.closest('.badge').style.display = 'inline-block';
            } else {
                previewCode.closest('.badge').style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}
