{% extends "settings_base.html" %}

{% block settings_content %}
    <hgroup>
        <h1>Settings</h1>
        <h2>Configure your API credentials and preferences</h2>
    </hgroup>

    <!-- Tesla Authentication Options -->
    <article>
        <header>
            <strong>Tesla API Authentication</strong>
        </header>
        <p>Connect to Tesla via Teslemetry for energy management (Powerwall/Solar).</p>

        <!-- Teslemetry (Proxy Service) -->
        <article style="margin-top: 1em;">
            <header style="background: rgba(100, 200, 150, 0.1); padding: 0.5em; border-radius: 0.5em;">
                <strong>Teslemetry</strong>
                <br><small>Tesla API Proxy Service</small>
            </header>

            {% if current_user.teslemetry_api_key_encrypted %}
                <!-- Connected -->
                <div style="padding: 0.8em; background: rgba(0, 255, 0, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0; color: #51cf66; font-size: 0.9em;">✅ <strong>Connected</strong></p>
                </div>

                <p style="font-size: 0.85em; margin: 0.5em 0;">API Key configured</p>

                <form action="{{ url_for('main.teslemetry_disconnect') }}" method="post" style="margin: 0.5em 0 0 0;">
                    <button type="submit" class="outline" style="width: 100%; font-size: 0.85em;" onclick="return confirm('Disconnect Teslemetry?')">Disconnect</button>
                </form>
            {% else %}
                <!-- Not connected -->
                <div style="padding: 0.8em; background: rgba(150, 150, 150, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0; color: #999; font-size: 0.9em;">⭕ <strong>Not Configured</strong></p>
                    <p style="margin: 0.3em 0 0 0; font-size: 0.75em;">Enter API key below</p>
                </div>

                <details style="margin-top: 0.5em;" open>
                    <summary style="font-size: 0.85em;">Setup Instructions</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 200, 150, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0 0 0.5em 0;"><strong>✅ Works with localhost (no public domain needed)</strong></p>

                        <ol style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.3em 0;">Go to <a href="https://teslemetry.com" target="_blank" style="font-weight: bold;">teslemetry.com</a></li>
                            <li style="margin: 0.3em 0;">Sign in with your Tesla account</li>
                            <li style="margin: 0.3em 0;">Authorize Teslemetry</li>
                            <li style="margin: 0.3em 0;">Copy your API key</li>
                            <li style="margin: 0.3em 0;">Paste it in the API Configuration section below</li>
                        </ol>
                    </div>
                </details>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">About Teslemetry</summary>
                    <p style="font-size: 0.8em; margin-top: 0.5em;">
                        ✓ Easy setup (2 minutes)<br>
                        ✓ Works with localhost<br>
                        ✓ Free for personal use<br>
                        ✓ Handles Tesla authentication<br>
                        ✓ Reliable and well-maintained
                    </p>
                </details>
            {% endif %}
        </article>
    </article>

    <!-- API Configuration Section -->
    <article>
        <header><strong>API Configuration</strong></header>
        <p>Configure your API credentials and energy site information.</p>
        <form action="{{ url_for('main.settings') }}" method="post" novalidate>
            {{ form.hidden_tag() }}

            <fieldset>
                <legend>Amber Electric</legend>
                <label for="amber_token">
                    {{ form.amber_token.label }}
                    <small>Get this from your Amber developer settings.</small>
                    {{ form.amber_token(size=64) }}
                </label>
            </fieldset>

            <fieldset style="margin-top: 1em;">
                <legend>Teslemetry (Optional)</legend>
                <label for="teslemetry_api_key">
                    {{ form.teslemetry_api_key.label }}
                    <small>Sign up at <a href="https://teslemetry.com" target="_blank">teslemetry.com</a>, connect your Tesla account, and paste your API key here.</small>
                    {{ form.teslemetry_api_key(size=64) }}
                </label>
            </fieldset>

            <fieldset style="margin-top: 1em;">
                <legend>Tesla Energy Site</legend>
                <label for="tesla_site_id">
                    {{ form.tesla_site_id.label }}
                    <small>Your Tesla energy site ID (Powerwall/Solar). Find this in Teslemetry dashboard or Tesla Fleet API products list.</small>
                    {{ form.tesla_site_id(size=32) }}
                </label>
            </fieldset>

            <fieldset style="margin-top: 1em;">
                <legend>User Preferences</legend>
                <label for="timezone">
                    {{ form.timezone.label }}
                    <small>Select your local timezone for accurate time display in logs and charts.</small>
                    {{ form.timezone() }}
                </label>
            </fieldset>

            {{ form.submit(class_="primary", style="margin-top: 1em;") }}
        </form>
    </article>
{% endblock settings_content %}
