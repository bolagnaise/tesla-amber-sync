{% extends "base.html" %}

{% block content %}
    <style>
        #import-selector:hover, #export-selector:hover {
            opacity: 0.85;
        }
    </style>

    <hgroup>
        <h1>Dashboard</h1>
        <h2>Real-time energy monitoring and pricing</h2>
    </hgroup>

    <!-- API Connection Status -->
    <div class="grid">
        <article id="amber-status" style="margin: 0; padding: 1em;">
            <header><strong>Amber Electric</strong></header>
            <p style="margin: 0;"><span class="status-indicator" id="amber-indicator">‚è≥</span> <span id="amber-message">Checking...</span></p>
        </article>

        <article id="tesla-status" style="margin: 0; padding: 1em;">
            <header><strong>Tesla</strong></header>
            <p style="margin: 0;"><span class="status-indicator" id="tesla-indicator">‚è≥</span> <span id="tesla-message">Checking...</span></p>
        </article>
    </div>

    <!-- 5-Minute Detailed Billing Window -->
    <article id="five-min-pricing" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; padding: 1.5em;">
        <header style="text-align: center; margin-bottom: 1em;">
            <strong style="font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px;">‚òÄÔ∏è Live 5 Min Price</strong>
            <div id="current-interval-time" style="font-size: 1.1em; font-weight: bold; margin-top: 0.3em;">--:-- - --:--</div>
        </header>
        <div style="display: flex; justify-content: center; gap: 2em; margin-bottom: 1.5em;">
            <div id="import-selector" onclick="selectPriceChannel('general')" style="text-align: center; cursor: pointer; transition: transform 0.2s;">
                <div style="background: rgba(253, 224, 71, 0.95); color: #1e3a8a; border-radius: 50%; width: 180px; height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                    <div id="current-general-price" style="font-size: 3.5em; font-weight: bold; line-height: 1;">--¬¢</div>
                    <div style="font-size: 0.9em; margin-top: 0.2em;">/kWh</div>
                    <div id="current-renewables" style="font-size: 1em; margin-top: 0.5em; opacity: 0.8;">--% renewables</div>
                </div>
                <div style="margin-top: 0.5em; font-size: 0.85em; opacity: 0.9;">IMPORT (BUY) ‚úì</div>
            </div>
            <div id="export-selector" onclick="selectPriceChannel('feedIn')" style="text-align: center; cursor: pointer; transition: transform 0.2s;">
                <div style="background: rgba(34, 197, 94, 0.2); border: 2px solid rgba(34, 197, 94, 0.5); border-radius: 12px; padding: 1em; min-width: 100px;">
                    <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 0.3em;">‚ö° EXPORT</div>
                    <div id="current-feedin-price" style="font-size: 2em; font-weight: bold;">--¬¢</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">/kWh</div>
                </div>
                <div style="margin-top: 0.5em; font-size: 0.85em; opacity: 0.9;">FEED-IN (SELL)</div>
            </div>
        </div>
        <div style="margin-top: 1.5em;">
            <div style="font-size: 0.95em; font-weight: bold; padding: 0.5em; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; margin-bottom: 1em;">üìä 30 Min Forecast - 5 Min Intervals</div>
            <div id="five-min-forecast" style="display: flex; gap: 0.5em; overflow-x: auto; padding: 0.5em 0;">
                <p style="color: rgba(255,255,255,0.7);">Loading forecast...</p>
            </div>
        </div>
    </article>

    <!-- Tesla Battery Status -->
    {% if current_user.tesla_energy_site_id %}
    <article id="battery-section">
        <header><strong>Tesla Powerwall Status</strong></header>
        <div id="battery-content">
            <p>Loading battery status...</p>
        </div>
    </article>
    {% endif %}

    <!-- Tariff Schedule -->
    <article id="tou-schedule-section">
        <header>
            <strong>Electricity Tariff Schedule (Rolling 24h)</strong>
            <div style="float: right;">
                <button id="refresh-schedule-btn" style="font-size: 0.9em; margin-right: 0.5em;">Refresh</button>
                {% if current_user.tesla_energy_site_id and (current_user.teslemetry_api_key_encrypted or current_user.tesla_access_token_encrypted) %}
                <button id="sync-tesla-btn" class="primary" style="font-size: 0.9em;">Sync to Tesla</button>
                {% endif %}
            </div>
        </header>
        <div id="sync-status" style="margin-bottom: 1em;"></div>
        <div id="tou-schedule-content">
            <p>Loading tariff schedule...</p>
        </div>
        <details id="tou-forecast-details" style="margin-top: 1em;">
            <summary>View Buy/Sell Price Chart</summary>
            <canvas id="forecastChart" style="max-height: 300px; margin-top: 1em;"></canvas>
        </details>
    </article>

    <!-- Price History Chart -->
    <article id="price-history-section">
        <header><strong>Price History (Last 24 Hours)</strong></header>
        <canvas id="priceChart" style="max-height: 300px;"></canvas>
    </article>

    <!-- Energy Usage Logging -->
    <article id="energy-usage-section">
        <header>
            <strong>Energy Usage History</strong>
            <div style="float: right;">
                <select id="timeframe-selector" style="font-size: 0.9em;">
                    <option value="day" selected>Day</option>
                    <option value="month">Month</option>
                    <option value="year">Year</option>
                </select>
            </div>
        </header>

        <!-- Energy Charts Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-top: 1em;">
            <!-- Solar Chart -->
            <div>
                <h4 style="margin: 0 0 0.5em 0;">Solar Generation</h4>
                <canvas id="solarChart" style="max-height: 200px;"></canvas>
            </div>

            <!-- Grid Chart -->
            <div>
                <h4 style="margin: 0 0 0.5em 0;">Grid Power</h4>
                <canvas id="gridChart" style="max-height: 200px;"></canvas>
            </div>

            <!-- Battery Chart -->
            <div>
                <h4 style="margin: 0 0 0.5em 0;">Battery Power</h4>
                <canvas id="batteryChart" style="max-height: 200px;"></canvas>
            </div>

            <!-- Load Chart -->
            <div>
                <h4 style="margin: 0 0 0.5em 0;">Home Load</h4>
                <canvas id="loadChart" style="max-height: 200px;"></canvas>
            </div>
        </div>
    </article>

    <!-- Energy Summaries (from Tesla Calendar History) -->
    <article id="energy-summaries-section">
        <header>
            <strong>Energy Summaries (Historical Totals)</strong>
            <div style="float: right;">
                <select id="summary-period-selector" style="font-size: 0.9em;">
                    <option value="day">Today</option>
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                    <option value="year">This Year</option>
                </select>
                <button id="refresh-summaries-btn" style="font-size: 0.9em; margin-left: 0.5em;">Refresh</button>
            </div>
        </header>
        <div id="energy-summaries-content" style="margin-top: 1em;">
            <p>Loading energy summaries...</p>
        </div>
    </article>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <script>
        // Track selected price channel (general = import, feedIn = export)
        let selectedChannel = 'general';

        // Function to select price channel and update display
        function selectPriceChannel(channel) {
            selectedChannel = channel;

            // Update visual indicators
            const importSelector = document.getElementById('import-selector');
            const exportSelector = document.getElementById('export-selector');

            if (channel === 'general') {
                // Import selected
                importSelector.querySelector(':scope > div:last-child').innerHTML = 'IMPORT (BUY) ‚úì';
                exportSelector.querySelector(':scope > div:last-child').innerHTML = 'FEED-IN (SELL)';
                importSelector.style.transform = 'scale(1.05)';
                exportSelector.style.transform = 'scale(1)';
            } else {
                // Export selected
                importSelector.querySelector(':scope > div:last-child').innerHTML = 'IMPORT (BUY)';
                exportSelector.querySelector(':scope > div:last-child').innerHTML = 'FEED-IN (SELL) ‚úì';
                importSelector.style.transform = 'scale(1)';
                exportSelector.style.transform = 'scale(1.05)';
            }

            // Regenerate forecast with selected channel
            generate5MinForecast();
        }

        // Check API status
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                // Update Amber status
                const amberIndicator = document.getElementById('amber-indicator');
                const amberMessage = document.getElementById('amber-message');
                if (status.amber.connected) {
                    amberIndicator.textContent = '‚úÖ';
                    amberMessage.textContent = 'Connected';
                    amberMessage.style.color = 'green';
                } else {
                    amberIndicator.textContent = '‚ùå';
                    amberMessage.textContent = status.amber.message;
                    amberMessage.style.color = 'red';
                }

                // Update Tesla status
                const teslaIndicator = document.getElementById('tesla-indicator');
                const teslaMessage = document.getElementById('tesla-message');
                if (status.tesla.connected) {
                    teslaIndicator.textContent = '‚úÖ';
                    teslaMessage.textContent = 'Connected';
                    teslaMessage.style.color = 'green';
                } else {
                    teslaIndicator.textContent = '‚ùå';
                    teslaMessage.textContent = status.tesla.message;
                    teslaMessage.style.color = 'red';
                }

                // If Amber is connected, fetch current prices
                if (status.amber.connected) {
                    await fetchCurrentPrices();
                }

                // If Tesla is connected, fetch battery status
                if (status.tesla.connected) {
                    await fetchTeslaStatus();
                }
            } catch (error) {
                console.error('Error checking API status:', error);
            }
        }

        // Update 5-minute billing window
        function update5MinWindow(prices) {
            const now = new Date();

            // Find current general and feedin prices
            const generalPrice = prices.find(p => p.channelType === 'general');
            const feedinPrice = prices.find(p => p.channelType === 'feedIn');

            if (generalPrice) {
                // Calculate current 5-minute interval
                const currentMinute = now.getMinutes();
                const intervalStart = Math.floor(currentMinute / 5) * 5;
                const intervalEnd = intervalStart + 5;

                const startTime = `${String(now.getHours()).padStart(2, '0')}:${String(intervalStart).padStart(2, '0')}`;
                const endTime = `${String(now.getHours()).padStart(2, '0')}:${String(intervalEnd).padStart(2, '0')}`;

                document.getElementById('current-interval-time').textContent = `${startTime} - ${endTime}`;
                document.getElementById('current-general-price').textContent = `${Math.abs(generalPrice.perKwh).toFixed(0)}¬¢`;
                document.getElementById('current-renewables').textContent = `${Math.round(generalPrice.renewables || 0)}% renewables`;
            }

            if (feedinPrice) {
                document.getElementById('current-feedin-price').textContent = `${Math.abs(feedinPrice.perKwh).toFixed(0)}¬¢`;
            }

            // Fetch and display 5-minute forecast (separate API call)
            generate5MinForecast();
        }

        // Fetch and display real 5-minute interval forecast from Amber API
        // Shows current 30-min period (from now) + next 30-min period
        async function generate5MinForecast() {
            const forecastDiv = document.getElementById('five-min-forecast');

            try {
                // Fetch 5-minute interval data from API
                const response = await fetch('/api/amber/5min-forecast');
                if (!response.ok) {
                    forecastDiv.innerHTML = '<p style="color: rgba(255,255,255,0.7);">5-minute forecast not available</p>';
                    return;
                }

                const data = await response.json();
                const generalIntervals = data.general || [];
                const feedinIntervals = data.feedIn || [];

                // Select intervals based on selected channel
                const sourceIntervals = selectedChannel === 'general' ? generalIntervals : feedinIntervals;

                if (sourceIntervals.length === 0) {
                    forecastDiv.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No forecast data available</p>';
                    return;
                }

                // Get current 5-minute interval and 30-minute period
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = Math.floor(now.getMinutes() / 5) * 5;
                const current30MinPeriod = Math.floor(now.getMinutes() / 30) * 30; // 0 or 30

                // Calculate end of current 30-min period and end of next 30-min period
                const currentPeriodEnd = current30MinPeriod + 30;
                const nextPeriodEnd = currentPeriodEnd + 30;

                // Filter intervals: from current interval to end of next 30-min period
                const filteredIntervals = sourceIntervals.filter(interval => {
                    const startTime = new Date(interval.startTime);
                    const hour = startTime.getHours();
                    const minute = startTime.getMinutes();

                    // Same hour, minute >= current minute, minute < next period end
                    if (hour === currentHour) {
                        if (nextPeriodEnd <= 60) {
                            // Next period doesn't cross hour boundary
                            return minute >= currentMinute && minute < nextPeriodEnd;
                        } else {
                            // Next period crosses hour boundary
                            return minute >= currentMinute;
                        }
                    }

                    // Next hour (if next period crosses hour boundary)
                    if (nextPeriodEnd > 60 && hour === (currentHour + 1) % 24) {
                        return minute < (nextPeriodEnd - 60);
                    }

                    return false;
                });

                // Generate HTML for individual 5-minute slots (matching Amber app)
                let html = '<div style="display: flex; gap: 0.5em; overflow-x: auto; padding: 0.5em 0;">';

                filteredIntervals.forEach((interval, idx) => {
                    const startTime = new Date(interval.startTime);
                    const hour = startTime.getHours();
                    const minute = startTime.getMinutes();
                    const timeLabel = `${hour}:${String(minute).padStart(2, '0')}`;

                    // Check if this is the current 5-minute interval
                    const isCurrent = (hour === currentHour && minute === currentMinute);

                    // Determine circle color based on price and channel type
                    let circleColor;
                    const absPrice = Math.abs(interval.perKwh);

                    if (selectedChannel === 'general') {
                        // Import prices - 4-color scale (green/yellow/orange/red)
                        if (absPrice < 20) {
                            circleColor = '#22c55e'; // green (<20¬¢)
                        } else if (absPrice < 30) {
                            circleColor = '#fbbf24'; // yellow (20-30¬¢)
                        } else if (absPrice < 40) {
                            circleColor = '#f59e0b'; // medium orange (30-40¬¢)
                        } else if (absPrice < 50) {
                            circleColor = '#f97316'; // dark orange (40-50¬¢)
                        } else {
                            circleColor = '#ef4444'; // red (‚â•50¬¢)
                        }
                    } else {
                        // Export prices - green scale
                        circleColor = '#22c55e'; // green (default)
                        if (absPrice < 5) {
                            circleColor = '#86efac'; // light green (very low)
                        } else if (absPrice >= 10) {
                            circleColor = '#16a34a'; // darker green (high)
                        }
                    }

                    // Border style: colored for current, subtle for others
                    const borderColor = selectedChannel === 'general' ? '#f97316' : '#22c55e';
                    const borderStyle = isCurrent ? `3px solid ${borderColor}` : '1px solid rgba(255,255,255,0.15)';
                    const bgStyle = isCurrent ? (selectedChannel === 'general' ? 'rgba(249, 115, 22, 0.1)' : 'rgba(34, 197, 94, 0.1)') : 'rgba(255,255,255,0.03)';

                    html += `
                        <div style="border: ${borderStyle}; border-radius: 12px; padding: 0.7em; min-width: 70px; background: ${bgStyle}; text-align: center;">
                            <div style="font-size: 0.75em; font-weight: ${isCurrent ? 'bold' : 'normal'}; margin-bottom: 0.4em; opacity: 0.9;">${timeLabel}</div>
                            <div style="color: ${circleColor}; font-size: 2.5em; line-height: 1;">‚óè</div>
                            <div style="font-size: 1em; font-weight: bold; margin-top: 0.3em;">${absPrice.toFixed(0)}¬¢</div>
                            <div style="font-size: 0.75em; opacity: 0.7; margin-top: 0.2em;">${Math.round(interval.renewables || 0)}%</div>
                        </div>
                    `;
                });

                html += '</div>';
                forecastDiv.innerHTML = html;

            } catch (error) {
                console.error('Error fetching 5-min forecast:', error);
                forecastDiv.innerHTML = '<p style="color: rgba(255,255,255,0.7);">Error loading forecast</p>';
            }
        }

        // Fetch current Amber prices
        async function fetchCurrentPrices() {
            try {
                const response = await fetch('/api/amber/current-price');
                if (!response.ok) {
                    // Don't spam console if Amber isn't configured
                    if (response.status !== 404 && response.status !== 500) {
                        console.error('Failed to fetch prices:', response.status);
                    }
                    return;
                }
                const prices = await response.json();

                // Update 5-minute billing window
                update5MinWindow(prices);

                // Fetch and update price history
                await fetchPriceHistory();
            } catch (error) {
                console.error('Error fetching current prices:', error);
            }
        }

        // Fetch Tesla battery status
        async function fetchTeslaStatus() {
            try {
                const response = await fetch('/api/tesla/status');
                if (!response.ok) {
                    throw new Error('Failed to fetch Tesla status');
                }
                const status = await response.json();

                const batteryContent = document.getElementById('battery-content');
                const batteryLevel = status.percentage_charged || 0;
                const batteryColor = batteryLevel > 80 ? 'green' :
                                    batteryLevel > 50 ? 'orange' : 'red';

                // Extract firmware version
                const firmwareVersion = status.firmware_version || 'Unknown';

                batteryContent.innerHTML = `
                    <div class="grid">
                        <div style="text-align: center;">
                            <p style="font-size: 3em; margin: 0; color: ${batteryColor};">
                                <strong>${batteryLevel.toFixed(0)}%</strong>
                            </p>
                            <p style="margin: 0.5em 0 0 0; color: #888;">Battery Level</p>
                        </div>
                        <div>
                            <p style="margin: 0.5em 0;"><strong>Solar:</strong> ${(status.solar_power / 1000).toFixed(2)} kW</p>
                            <p style="margin: 0.5em 0;"><strong>Battery:</strong> ${(status.battery_power / 1000).toFixed(2)} kW</p>
                            <p style="margin: 0.5em 0;"><strong>Grid:</strong> ${(status.grid_power / 1000).toFixed(2)} kW</p>
                            <p style="margin: 0.5em 0; padding-top: 0.5em; border-top: 1px solid rgba(255,255,255,0.1);"><strong>Firmware:</strong> <span style="font-family: monospace;">${firmwareVersion}</span></p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching Tesla status:', error);
                document.getElementById('battery-content').innerHTML =
                    '<p style="color: red;">Error loading battery status.</p>';
            }
        }

        // Fetch and display price history chart
        let priceChart = null;
        async function fetchPriceHistory() {
            try {
                const response = await fetch('/api/price-history');
                if (!response.ok) {
                    throw new Error('Failed to fetch price history');
                }
                const history = await response.json();

                if (history.length === 0) {
                    return;
                }

                const ctx = document.getElementById('priceChart').getContext('2d');

                // Destroy existing chart if it exists
                if (priceChart) {
                    priceChart.destroy();
                }

                const labels = history.map(record => {
                    const date = new Date(record.timestamp);
                    return date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
                });

                const data = history.map(record => record.per_kwh);

                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Price (¬¢/kWh)',
                            data: data,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Price (¬¢/kWh)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching price history:', error);
            }
        }

        // Fetch and display TOU tariff schedule
        let forecastChart = null;
        async function fetchTOUSchedule() {
            try {
                const response = await fetch('/api/tou-schedule');
                if (!response.ok) {
                    throw new Error('Failed to fetch TOU schedule');
                }
                const data = await response.json();

                const content = document.getElementById('tou-schedule-content');
                let html = '';

                // Display stats
                const stats = data.stats;
                if (stats) {
                    html += `<div class="grid" style="margin-bottom: 1em;">
                        <div style="text-align: center;">
                            <p style="margin: 0; font-size: 0.9em; color: #888;">Buy Price Range</p>
                            <p style="margin: 0; font-size: 1.3em;"><strong>${stats.buy.min.toFixed(1)}¬¢ - ${stats.buy.max.toFixed(1)}¬¢</strong></p>
                            <p style="margin: 0; font-size: 0.85em; color: #666;">Avg: ${stats.buy.avg.toFixed(1)}¬¢/kWh</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="margin: 0; font-size: 0.9em; color: #888;">Sell Price Range</p>
                            <p style="margin: 0; font-size: 1.3em;"><strong>${stats.sell.min.toFixed(1)}¬¢ - ${stats.sell.max.toFixed(1)}¬¢</strong></p>
                            <p style="margin: 0; font-size: 0.85em; color: #666;">Avg: ${stats.sell.avg.toFixed(1)}¬¢/kWh</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="margin: 0; font-size: 0.9em; color: #888;">Total Periods</p>
                            <p style="margin: 0; font-size: 1.3em;"><strong>${stats.total_periods}</strong></p>
                            <p style="margin: 0; font-size: 0.85em; color: #666;">30-min intervals</p>
                        </div>
                    </div>`;

                    html += `<p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                        Tariff: ${data.tariff_name || 'Unknown'}
                    </p>`;
                }

                // Display tariff table
                const periods = data.periods || [];
                if (periods.length > 0) {
                    html += `<div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead style="position: sticky; top: 0; background: #1e1e1e;">
                                <tr style="border-bottom: 2px solid #444;">
                                    <th style="text-align: left; padding: 0.5em;">Time</th>
                                    <th style="text-align: right; padding: 0.5em;">Buy (¬¢/kWh)</th>
                                    <th style="text-align: right; padding: 0.5em;">Sell (¬¢/kWh)</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    // Get current time in Brisbane timezone for highlighting current period
                    const now = new Date();
                    const currentHour = now.getHours();
                    const currentMinute = now.getMinutes();

                    periods.forEach((period, i) => {
                        const buyColor = period.buy_price > stats.buy.avg * 1.2 ? '#ff6b6b' :
                                        period.buy_price < stats.buy.avg * 0.8 ? '#51cf66' : '#fff';
                        const sellColor = period.sell_price > stats.sell.avg * 1.2 ? '#51cf66' :
                                         period.sell_price < stats.sell.avg * 0.8 ? '#ff6b6b' : '#fff';

                        // Parse period time (format: "HH:MM - HH:MM")
                        const timeMatch = period.time.match(/(\d{1,2}):(\d{2})/);
                        let isCurrentPeriod = false;

                        if (timeMatch) {
                            const periodHour = parseInt(timeMatch[1]);
                            const periodMinute = parseInt(timeMatch[2]);

                            // Check if current time falls within this 30-min period
                            if (periodHour === currentHour &&
                                Math.floor(currentMinute / 30) === Math.floor(periodMinute / 30)) {
                                isCurrentPeriod = true;
                            }
                        }

                        // Add visual indicators for current period
                        const rowStyle = isCurrentPeriod
                            ? 'border-bottom: 1px solid #333; background: rgba(81, 207, 102, 0.15); border-left: 3px solid #51cf66;'
                            : 'border-bottom: 1px solid #333;';

                        const timeDisplay = isCurrentPeriod
                            ? `<strong>‚ñ∂ ${period.time}</strong>`
                            : period.time;

                        html += `<tr style="${rowStyle}">
                            <td style="padding: 0.5em;">${timeDisplay}</td>
                            <td style="text-align: right; padding: 0.5em; color: ${buyColor}; font-weight: bold;">
                                ${period.buy_price.toFixed(2)}
                            </td>
                            <td style="text-align: right; padding: 0.5em; color: ${sellColor}; font-weight: bold;">
                                ${period.sell_price.toFixed(2)}
                            </td>
                        </tr>`;
                    });

                    html += `</tbody></table></div>`;

                    html += `<p style="font-size: 0.8em; color: #666; margin-top: 1em;">
                        <span style="color: #51cf66;">‚ñ∂</span> Current period &nbsp;
                        <span style="color: #51cf66;">‚óè</span> Green = Good price &nbsp;
                        <span style="color: #ff6b6b;">‚óè</span> Red = High price &nbsp;
                        <span style="color: #fff;">‚óè</span> White = Average
                    </p>`;
                }

                content.innerHTML = html;

                // Update chart
                if (periods.length > 0) {
                    updateTariffChart(periods);
                }

            } catch (error) {
                console.error('Error fetching TOU schedule:', error);
                document.getElementById('tou-schedule-content').innerHTML =
                    '<p style="color: red;">Error loading tariff schedule. Please check your Amber API configuration in Settings.</p>';
            }
        }

        function updateTariffChart(periods) {
            const ctx = document.getElementById('forecastChart').getContext('2d');

            // Destroy existing chart if it exists
            if (forecastChart) {
                forecastChart.destroy();
            }

            // Extract labels and data from periods
            const labels = periods.map(period => period.time);
            const buyPrices = periods.map(period => period.buy_price);
            const sellPrices = periods.map(period => period.sell_price);

            // Find current period index for vertical line
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            let currentPeriodIndex = -1;

            periods.forEach((period, i) => {
                const timeMatch = period.time.match(/(\d{1,2}):(\d{2})/);
                if (timeMatch) {
                    const periodHour = parseInt(timeMatch[1]);
                    const periodMinute = parseInt(timeMatch[2]);

                    if (periodHour === currentHour &&
                        Math.floor(currentMinute / 30) === Math.floor(periodMinute / 30)) {
                        currentPeriodIndex = i;
                    }
                }
            });

            // Prepare annotation for current time
            const annotations = {};
            if (currentPeriodIndex >= 0) {
                annotations.currentTime = {
                    type: 'line',
                    xMin: currentPeriodIndex,
                    xMax: currentPeriodIndex,
                    borderColor: 'rgba(81, 207, 102, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: {
                        display: true,
                        content: 'NOW',
                        position: 'start',
                        backgroundColor: 'rgba(81, 207, 102, 0.8)',
                        color: '#1e1e1e',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        padding: 4
                    }
                };
            }

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Buy Price (¬¢/kWh)',
                            data: buyPrices,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: true
                        },
                        {
                            label: 'Sell Price (¬¢/kWh)',
                            data: sellPrices,
                            borderColor: 'rgb(75, 192, 75)',
                            backgroundColor: 'rgba(75, 192, 75, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '¬¢/kWh';
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price (¬¢/kWh)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (24-hour rolling window)'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 12
                            }
                        }
                    }
                }
            });
        }

        // Sync to Tesla handler
        async function syncTeslaSchedule() {
            const syncBtn = document.getElementById('sync-tesla-btn');
            const syncStatus = document.getElementById('sync-status');

            try {
                // Disable button and show loading state
                syncBtn.disabled = true;
                syncBtn.textContent = 'Syncing...';
                syncStatus.innerHTML = '<p style="color: blue;">‚è≥ Syncing schedule to Tesla Powerwall...</p>';

                const response = await fetch('/api/sync-tesla-schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    syncStatus.innerHTML = `
                        <p style="color: green;">‚úÖ ${result.message}</p>
                        <p style="font-size: 0.9em; margin: 0.5em 0;">
                            Updated ${result.rate_periods} pricing periods to Tesla.
                            Tariff: ${result.tariff_name}
                        </p>
                    `;
                    // Auto-hide success message after 10 seconds
                    setTimeout(() => {
                        syncStatus.innerHTML = '';
                    }, 10000);
                } else {
                    throw new Error(result.error || 'Failed to sync schedule');
                }
            } catch (error) {
                console.error('Error syncing Tesla schedule:', error);
                syncStatus.innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
            } finally {
                // Re-enable button
                syncBtn.disabled = false;
                syncBtn.textContent = 'Sync to Tesla';
            }
        }

        // Refresh button handler
        document.getElementById('refresh-schedule-btn')?.addEventListener('click', fetchTOUSchedule);

        // Sync button handler
        document.getElementById('sync-tesla-btn')?.addEventListener('click', syncTeslaSchedule);

        // Initial load
        checkAPIStatus();
        fetchTOUSchedule();

        // Refresh current prices every 1 minute (Amber updates every 5 mins, so we catch updates quickly)
        setInterval(fetchCurrentPrices, 60 * 1000);
        // Check API status every 5 minutes
        setInterval(checkAPIStatus, 5 * 60 * 1000);
        // Refresh TOU schedule every hour
        setInterval(fetchTOUSchedule, 60 * 60 * 1000);
        // Fetch energy usage history on load and when timeframe changes
        fetchEnergyUsageHistory();
        document.getElementById('timeframe-selector').addEventListener('change', fetchEnergyUsageHistory);
        // Refresh energy charts every 5 minutes
        setInterval(fetchEnergyUsageHistory, 5 * 60 * 1000);

        // Energy Usage Charts
        let solarChart = null;
        let gridChart = null;
        let batteryChart = null;
        let loadChart = null;

        async function fetchEnergyUsageHistory() {
            try {
                const timeframe = document.getElementById('timeframe-selector').value;
                const response = await fetch(`/api/energy-history?timeframe=${timeframe}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch energy history');
                }
                const history = await response.json();

                if (history.length === 0) {
                    return;
                }

                // Prepare data
                const labels = history.map(record => {
                    const date = new Date(record.timestamp);
                    if (timeframe === 'day') {
                        return date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
                    } else if (timeframe === 'month') {
                        return date.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' });
                    } else {
                        return date.toLocaleDateString('en-AU', { month: 'short', year: 'numeric' });
                    }
                });

                const solarData = history.map(r => r.solar_power / 1000); // Convert to kW
                const gridData = history.map(r => r.grid_power / 1000);
                const batteryData = history.map(r => r.battery_power / 1000);
                const loadData = history.map(r => r.load_power / 1000);

                // Update charts
                updateEnergyChart('solarChart', solarChart, labels, solarData, 'Solar Generation (kW)', 'rgb(255, 193, 7)', (chart) => { solarChart = chart; });
                updateEnergyChart('gridChart', gridChart, labels, gridData, 'Grid Power (kW)', 'rgb(76, 175, 80)', (chart) => { gridChart = chart; });
                updateEnergyChart('batteryChart', batteryChart, labels, batteryData, 'Battery Power (kW)', 'rgb(33, 150, 243)', (chart) => { batteryChart = chart; });
                updateEnergyChart('loadChart', loadChart, labels, loadData, 'Home Load (kW)', 'rgb(156, 39, 176)', (chart) => { loadChart = chart; });

            } catch (error) {
                console.error('Error fetching energy usage history:', error);
            }
        }

        function updateEnergyChart(canvasId, existingChart, labels, data, label, color, setChart) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // Destroy existing chart if it exists
            if (existingChart) {
                existingChart.destroy();
            }

            const newChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: label
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            setChart(newChart);
        }

        // Energy Summaries from Tesla Calendar History
        async function fetchEnergySummaries() {
            try {
                const period = document.getElementById('summary-period-selector').value;
                const response = await fetch(`/api/energy-calendar-history?period=${period}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch energy summaries');
                }
                const data = await response.json();

                if (!data.time_series || data.time_series.length === 0) {
                    document.getElementById('energy-summaries-content').innerHTML = '<p style="color: #888;">No historical data available for this period.</p>';
                    return;
                }

                // Calculate totals from time series
                let totalSolar = 0;
                let totalGridImport = 0;
                let totalGridExport = 0;
                let totalBatteryCharge = 0;
                let totalBatteryDischarge = 0;
                let totalConsumer = 0;

                data.time_series.forEach(entry => {
                    totalSolar += entry.solar_energy_exported || 0;
                    totalGridImport += entry.grid_energy_imported || 0;
                    totalGridExport += entry.grid_energy_exported_from_solar || 0;
                    totalGridExport += entry.grid_energy_exported_from_battery || 0;
                    totalBatteryCharge += entry.battery_energy_imported_from_grid || 0;
                    totalBatteryCharge += entry.battery_energy_imported_from_solar || 0;
                    totalBatteryDischarge += entry.battery_energy_exported || 0;
                    totalConsumer += entry.consumer_energy_imported_from_grid || 0;
                    totalConsumer += entry.consumer_energy_imported_from_solar || 0;
                    totalConsumer += entry.consumer_energy_imported_from_battery || 0;
                });

                // Display summaries in a grid
                const summariesHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1em;">
                        <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid rgb(255, 193, 7); padding: 1em;">
                            <h4 style="margin: 0; color: rgb(255, 193, 7);">Solar Generated</h4>
                            <p style="font-size: 2em; margin: 0.5em 0 0 0;">${(totalSolar / 1000).toFixed(1)} kWh</p>
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid rgb(76, 175, 80); padding: 1em;">
                            <h4 style="margin: 0; color: rgb(76, 175, 80);">Grid Import</h4>
                            <p style="font-size: 2em; margin: 0.5em 0 0 0;">${(totalGridImport / 1000).toFixed(1)} kWh</p>
                        </div>
                        <div style="background: rgba(139, 195, 74, 0.1); border-left: 4px solid rgb(139, 195, 74); padding: 1em;">
                            <h4 style="margin: 0; color: rgb(139, 195, 74);">Grid Export</h4>
                            <p style="font-size: 2em; margin: 0.5em 0 0 0;">${(totalGridExport / 1000).toFixed(1)} kWh</p>
                        </div>
                        <div style="background: rgba(33, 150, 243, 0.1); border-left: 4px solid rgb(33, 150, 243); padding: 1em;">
                            <h4 style="margin: 0; color: rgb(33, 150, 243);">Battery Charge</h4>
                            <p style="font-size: 2em; margin: 0.5em 0 0 0;">${(totalBatteryCharge / 1000).toFixed(1)} kWh</p>
                        </div>
                        <div style="background: rgba(63, 81, 181, 0.1); border-left: 4px solid rgb(63, 81, 181); padding: 1em;">
                            <h4 style="margin: 0; color: rgb(63, 81, 181);">Battery Discharge</h4>
                            <p style="font-size: 2em; margin: 0.5em 0 0 0;">${(totalBatteryDischarge / 1000).toFixed(1)} kWh</p>
                        </div>
                        <div style="background: rgba(156, 39, 176, 0.1); border-left: 4px solid rgb(156, 39, 176); padding: 1em;">
                            <h4 style="margin: 0; color: rgb(156, 39, 176);">Home Consumption</h4>
                            <p style="font-size: 2em; margin: 0.5em 0 0 0;">${(totalConsumer / 1000).toFixed(1)} kWh</p>
                        </div>
                    </div>
                    <p style="margin-top: 1em; color: #666; font-size: 0.9em;">
                        <strong>Period:</strong> ${period === 'week' ? 'This Week' : period === 'month' ? 'This Month' : 'This Year'}
                        (${data.time_series.length} ${data.time_series.length === 1 ? 'day' : 'days'})
                    </p>
                `;

                document.getElementById('energy-summaries-content').innerHTML = summariesHTML;

            } catch (error) {
                console.error('Error fetching energy summaries:', error);
                document.getElementById('energy-summaries-content').innerHTML = '<p style="color: red;">Error loading energy summaries. Tesla calendar history may not be available.</p>';
            }
        }

        // Initialize summaries
        fetchEnergySummaries();
        document.getElementById('summary-period-selector').addEventListener('change', fetchEnergySummaries);
        document.getElementById('refresh-summaries-btn').addEventListener('click', fetchEnergySummaries);
    </script>

    <style>
        .status-indicator {
            font-size: 1.5em;
        }
    </style>
{% endblock %}
