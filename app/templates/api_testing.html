{% extends "settings_base.html" %}

{% block settings_content %}
<h1>Amber API Testing</h1>
<p>Test all available Amber Electric API endpoints and view their raw responses.</p>

<!-- API Connection Status -->
<article id="connection-status">
    <h3>Connection Status</h3>
    <div id="status-display">
        <p>Checking connection...</p>
    </div>
</article>

<!-- Available Sites -->
<article>
    <h3>Sites</h3>
    <button onclick="testEndpoint('sites')" class="contrast">GET /v1/sites</button>
    <details id="response-sites">
        <summary>Response</summary>
        <pre><code id="output-sites">Click the button to test this endpoint</code></pre>
    </details>
</article>

<!-- Current Prices -->
<article>
    <h3>Current Prices</h3>
    <button onclick="testEndpoint('current-prices')" class="contrast">GET /v1/sites/{site_id}/prices/current</button>
    <details id="response-current-prices">
        <summary>Response</summary>
        <pre><code id="output-current-prices">Click the button to test this endpoint</code></pre>
    </details>
</article>

<!-- Advanced Price Schema -->
<article style="border: 2px solid var(--primary); background-color: var(--card-background-color);">
    <h3>‚≠ê Advanced Price Schema (30-min forecast with ML predictions)</h3>
    <p><strong>This endpoint shows the <code>advancedPrice.predicted</code> field used in TOU tariff conversion.</strong></p>
    <p>The advanced price includes ML-based forecasts that SmartShift and Netzero use for optimal battery control.</p>
    <button onclick="testAdvancedPriceSchema()" class="contrast">GET Price Forecast with Advanced Schema</button>
    <details id="response-advanced-price">
        <summary>Response (with Advanced Price breakdown)</summary>
        <pre><code id="output-advanced-price">Click the button to see the advanced price structure</code></pre>
    </details>
</article>

<!-- Price Forecast - Default (24 hours) -->
<article>
    <h3>Price Forecast (24 hours, default resolution)</h3>
    <button onclick="testEndpoint('price-forecast', {next_hours: 24})" class="contrast">GET /v1/sites/{site_id}/prices</button>
    <details id="response-price-forecast">
        <summary>Response</summary>
        <pre><code id="output-price-forecast">Click the button to test this endpoint</code></pre>
    </details>
</article>

<!-- Price Forecast - 48 hours -->
<article>
    <h3>Price Forecast (48 hours, default resolution)</h3>
    <button onclick="testEndpoint('price-forecast-48h', {next_hours: 48})" class="contrast">GET /v1/sites/{site_id}/prices?next_hours=48</button>
    <details id="response-price-forecast-48h">
        <summary>Response</summary>
        <pre><code id="output-price-forecast-48h">Click the button to test this endpoint</code></pre>
    </details>
</article>

<!-- Price Forecast - 5 minute resolution -->
<article>
    <h3>Price Forecast (24 hours, 5-minute resolution)</h3>
    <button onclick="testEndpoint('price-forecast-5min', {next_hours: 24, resolution: 5})" class="contrast">GET /v1/sites/{site_id}/prices?resolution=5</button>
    <details id="response-price-forecast-5min">
        <summary>Response</summary>
        <pre><code id="output-price-forecast-5min">Click the button to test this endpoint</code></pre>
    </details>
</article>

<!-- Price Forecast - 30 minute resolution -->
<article>
    <h3>Price Forecast (48 hours, 30-minute resolution)</h3>
    <button onclick="testEndpoint('price-forecast-30min', {next_hours: 48, resolution: 30})" class="contrast">GET /v1/sites/{site_id}/prices?resolution=30</button>
    <details id="response-price-forecast-30min">
        <summary>Response</summary>
        <pre><code id="output-price-forecast-30min">Click the button to test this endpoint</code></pre>
    </details>
</article>

<!-- Usage -->
<article>
    <h3>Usage History (Last 7 days)</h3>
    <button onclick="testEndpoint('usage')" class="contrast">GET /v1/sites/{site_id}/usage</button>
    <details id="response-usage">
        <summary>Response</summary>
        <pre><code id="output-usage">Click the button to test this endpoint</code></pre>
    </details>
</article>

<!-- Netzero vs Your Implementation Comparison -->
<article style="border: 2px solid #ff6b35; background-color: var(--card-background-color);">
    <h3>‚ö° LIVE Netzero vs Your Implementation (Side-by-Side)</h3>
    <p><strong>Compare the ACTUAL Netzero TOU schedule on your Tesla with your implementation.</strong></p>
    <p>This fetches the current TOU settings from your Tesla Powerwall (what Netzero set) and compares it period-by-period with what your implementation would create using the same Amber data.</p>

    <p><em>Setup Required:</em></p>
    <ol>
        <li>Configure your Teslemetry API key in Settings</li>
        <li>Click "Find Tesla Sites" below to get your Site ID</li>
        <li>Copy the Site ID and save it in Settings</li>
    </ol>

    <button onclick="findTeslaSites()" style="background-color: #4CAF50;">1. Find Tesla Sites (Get Site ID)</button>
    <button onclick="testNetzeroComparison()" style="background-color: #ff6b35;">2. Compare Live Schedules</button>

    <details id="response-find-sites">
        <summary>Tesla Sites Found</summary>
        <pre><code id="output-find-sites">Click "Find Tesla Sites" to discover your Site ID</code></pre>
    </details>

    <details id="response-netzero-comparison">
        <summary>Netzero vs Yours - Side by Side</summary>
        <pre><code id="output-netzero-comparison">Complete setup steps above, then click "Compare Live Schedules"</code></pre>
    </details>
</article>

<!-- Tariff Implementation Comparison -->
<article style="border: 2px solid var(--del-color); background-color: var(--card-background-color);">
    <h3>üîç Tariff Implementation Comparison (Debug Price Differences)</h3>
    <p><strong>Compare your implementation vs. what Netzero might be doing.</strong></p>
    <p>This shows:</p>
    <ul>
        <li>Your current implementation (with 30-min advance shift)</li>
        <li>Hypothetical "no-shift" version (direct price mapping)</li>
        <li>Raw API data structure (check if predicted is number or object)</li>
    </ul>
    <button onclick="testTariffComparison()" style="background-color: var(--del-color);">Compare Implementations</button>
    <details id="response-tariff-comparison">
        <summary>Comparison Results</summary>
        <pre><code id="output-tariff-comparison">Click the button to see the comparison</code></pre>
    </details>
</article>

<!-- Custom Raw API Call -->
<article>
    <h3>Custom Raw API Call</h3>
    <form id="raw-api-form" onsubmit="testRawEndpoint(event)">
        <label for="raw-endpoint">
            Endpoint Path
            <input type="text" id="raw-endpoint" name="endpoint" placeholder="/sites" value="/sites">
        </label>
        <label for="raw-method">
            HTTP Method
            <select id="raw-method" name="method">
                <option value="GET" selected>GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
            </select>
        </label>
        <button type="submit" class="contrast">Execute Custom Call</button>
    </form>
    <details id="response-raw">
        <summary>Response</summary>
        <pre><code id="output-raw">Submit the form to test a custom endpoint</code></pre>
    </details>
</article>

<script>
// Check connection status on load
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        const statusDiv = document.getElementById('status-display');

        if (data.amber && data.amber.connected) {
            statusDiv.innerHTML = `
                <p style="color: var(--ins-color);">‚úì Amber API: Connected</p>
            `;
        } else {
            statusDiv.innerHTML = `
                <p style="color: var(--del-color);">‚úó Amber API: Not connected</p>
                <p>Please configure your Amber API token in Settings.</p>
            `;
        }
    } catch (error) {
        document.getElementById('status-display').innerHTML = `
            <p style="color: var(--del-color);">Error checking connection: ${error.message}</p>
        `;
    }
});

async function testEndpoint(name, params = {}) {
    const outputElement = document.getElementById(`output-${name}`);
    const detailsElement = document.getElementById(`response-${name}`);

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        let url;
        switch (name) {
            case 'sites':
                url = '/api/test/amber/sites';
                break;
            case 'current-prices':
                url = '/api/test/amber/current-prices';
                break;
            case 'price-forecast':
            case 'price-forecast-48h':
            case 'price-forecast-5min':
            case 'price-forecast-30min':
                const queryParams = new URLSearchParams(params).toString();
                url = `/api/test/amber/price-forecast?${queryParams}`;
                break;
            case 'usage':
                url = '/api/test/amber/usage';
                break;
            default:
                throw new Error('Unknown endpoint');
        }

        const response = await fetch(url);
        const data = await response.json();

        // Pretty print JSON with metadata
        let output = `Endpoint: ${data.endpoint || 'N/A'}\n`;
        if (data.count !== undefined) {
            output += `Count: ${data.count} records\n`;
        }
        output += `Status: ${response.status}\n\n`;
        output += `Response:\n${JSON.stringify(data.data, null, 2)}`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function testAdvancedPriceSchema() {
    const outputElement = document.getElementById('output-advanced-price');
    const detailsElement = document.getElementById('response-advanced-price');

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        // Fetch 30-minute forecast data which includes advanced price schema
        const response = await fetch('/api/test/amber/advanced-price-schema');
        const data = await response.json();

        if (!data.success) {
            outputElement.textContent = `Error: ${data.error}`;
            return;
        }

        // Format the output to highlight the advanced price structure
        let output = `Endpoint: ${data.endpoint}\n`;
        output += `Records: ${data.count}\n`;
        output += `Status: ${response.status}\n\n`;

        output += `=== ADVANCED PRICE STRUCTURE ===\n\n`;

        if (data.sample) {
            output += `Sample Record (First 30-min interval):\n`;
            output += `Period: ${data.sample.period}\n`;
            output += `Channel Type: ${data.sample.channelType}\n`;
            output += `Spike Status: ${data.sample.spikeStatus}\n\n`;

            output += `--- Base Price Fields ---\n`;
            output += `per_kwh: ${data.sample.perKwh} c/kWh\n`;
            output += `spot_per_kwh: ${data.sample.spotPerKwh} c/kWh\n\n`;

            if (data.sample.advancedPrice) {
                output += `--- Advanced Price Object (ML Forecast) ---\n`;
                output += JSON.stringify(data.sample.advancedPrice, null, 2);
                output += `\n\n`;
                output += `Key Fields Explained:\n`;
                output += `‚Ä¢ predicted: ML-predicted price (used by SmartShift/Netzero)\n`;
                output += `‚Ä¢ actual: Actual measured price (null for future intervals)\n`;
                output += `‚Ä¢ renewables: Percentage of renewable energy\n`;
                output += `‚Ä¢ channelType: 'general' (import) or 'feedIn' (export)\n`;
            }
        }

        output += `\n\n=== FULL API RESPONSE (ALL RECORDS) ===\n\n`;
        output += JSON.stringify(data.data, null, 2);

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function findTeslaSites() {
    const outputElement = document.getElementById('output-find-sites');
    const detailsElement = document.getElementById('response-find-sites');

    // Show loading state
    outputElement.textContent = 'Loading... (Connecting to Tesla via Teslemetry)';
    detailsElement.open = true;

    try {
        const response = await fetch('/api/test/find-tesla-sites');
        const data = await response.json();

        if (!data.success) {
            let output = `Error: ${data.error}\n\n`;
            if (data.help) {
                output += `Help: ${data.help}\n`;
            }
            outputElement.textContent = output;
            return;
        }

        // Format the output
        let output = `=== TESLA SITES FOUND ===\n\n`;
        output += `${data.instructions}\n\n`;

        for (const site of data.sites) {
            output += `Site Name: ${site.site_name}\n`;
            output += `Site ID: ${site.site_id} ‚Üê COPY THIS!\n`;
            output += `Type: ${site.resource_type}\n`;
            output += `\n`;
        }

        output += `\nNEXT STEPS:\n`;
        output += `1. Copy the Site ID above\n`;
        output += `2. Go to Settings (navigation menu)\n`;
        output += `3. Paste it into "Tesla Site ID" field\n`;
        output += `4. Click Save\n`;
        output += `5. Come back here and click "Compare Live Schedules"\n`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function testNetzeroComparison() {
    const outputElement = document.getElementById('output-netzero-comparison');
    const detailsElement = document.getElementById('response-netzero-comparison');

    // Show loading state
    outputElement.textContent = 'Loading... (Fetching from Tesla and Amber)';
    detailsElement.open = true;

    try {
        const response = await fetch('/api/test/netzero-comparison');
        const data = await response.json();

        if (!data.success) {
            let output = `Error: ${data.error}\n\n`;
            if (data.help) {
                output += `Help: ${data.help}\n\n`;
            }
            if (data.next_step) {
                output += `Next Step: ${data.next_step}\n\n`;
            }
            if (data.traceback) {
                output += `Technical Details:\n${data.traceback}`;
            }
            outputElement.textContent = output;
            return;
        }

        // Format the comparison output
        let output = `=== LIVE COMPARISON: NETZERO vs YOUR IMPLEMENTATION ===\n\n`;
        output += `Netzero Tariff Name: ${data.netzero_tariff_name}\n`;
        output += `Your Tariff Name: ${data.our_tariff_name}\n\n`;

        output += `--- STATISTICS ---\n`;
        output += `Total Periods: ${data.statistics.total_periods}\n`;
        output += `Periods Compared: ${data.statistics.periods_compared}\n\n`;

        output += `BUY PRICE DIFFERENCES:\n`;
        if (data.statistics.buy_price_stats.avg_diff !== null) {
            output += `  Min Difference: $${data.statistics.buy_price_stats.min_diff.toFixed(4)}\n`;
            output += `  Max Difference: $${data.statistics.buy_price_stats.max_diff.toFixed(4)}\n`;
            output += `  Avg Difference: $${data.statistics.buy_price_stats.avg_diff.toFixed(4)}\n`;
            output += `  Avg Abs Difference: $${data.statistics.buy_price_stats.avg_abs_diff.toFixed(4)}\n\n`;
        }

        output += `SELL PRICE DIFFERENCES:\n`;
        if (data.statistics.sell_price_stats.avg_diff !== null) {
            output += `  Min Difference: $${data.statistics.sell_price_stats.min_diff.toFixed(4)}\n`;
            output += `  Max Difference: $${data.statistics.sell_price_stats.max_diff.toFixed(4)}\n`;
            output += `  Avg Difference: $${data.statistics.sell_price_stats.avg_diff.toFixed(4)}\n`;
            output += `  Avg Abs Difference: $${data.statistics.sell_price_stats.avg_abs_diff.toFixed(4)}\n\n`;
        }

        output += `--- PERIOD-BY-PERIOD COMPARISON (ALL 48 PERIODS) ---\n\n`;
        output += `Format: PERIOD | Netzero Buy | Your Buy | Diff | Diff% | Netzero Sell | Your Sell | Diff | Diff%\n`;
        output += `${'='.repeat(120)}\n`;

        for (const period of data.comparison) {
            const netBuy = period.netzero_buy !== null ? `$${period.netzero_buy.toFixed(4)}` : 'N/A';
            const ourBuy = period.our_buy !== null ? `$${period.our_buy.toFixed(4)}` : 'N/A';
            const buyDiff = period.buy_diff !== null ? `$${period.buy_diff.toFixed(4)}` : 'N/A';
            const buyDiffPct = period.buy_diff_pct !== null ? `${period.buy_diff_pct.toFixed(2)}%` : 'N/A';

            const netSell = period.netzero_sell !== null ? `$${period.netzero_sell.toFixed(4)}` : 'N/A';
            const ourSell = period.our_sell !== null ? `$${period.our_sell.toFixed(4)}` : 'N/A';
            const sellDiff = period.sell_diff !== null ? `$${period.sell_diff.toFixed(4)}` : 'N/A';
            const sellDiffPct = period.sell_diff_pct !== null ? `${period.sell_diff_pct.toFixed(2)}%` : 'N/A';

            output += `${period.period} | ${netBuy} | ${ourBuy} | ${buyDiff} | ${buyDiffPct} | ${netSell} | ${ourSell} | ${sellDiff} | ${sellDiffPct}\n`;
        }

        output += `\n--- ANALYSIS ---\n`;
        if (data.statistics.buy_price_stats.avg_abs_diff !== null) {
            const avgDiff = Math.abs(data.statistics.buy_price_stats.avg_diff);
            if (avgDiff < 0.0001) {
                output += `‚úÖ Prices are NEARLY IDENTICAL (avg diff < $0.0001)\n`;
            } else if (avgDiff < 0.001) {
                output += `‚ö†Ô∏è  Prices are very close but have small differences (avg diff < $0.001)\n`;
            } else {
                output += `‚ùå Prices have SIGNIFICANT differences (avg diff = $${avgDiff.toFixed(4)})\n`;
                output += `\nPossible causes:\n`;
                output += `1. 30-minute advance shift (your implementation uses next slot's price)\n`;
                output += `2. Different advancedPrice field structure\n`;
                output += `3. Different Amber API resolution (5min vs 30min)\n`;
                output += `4. Rolling window logic (past periods use tomorrow's prices)\n`;
            }
        }

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function testTariffComparison() {
    const outputElement = document.getElementById('output-tariff-comparison');
    const detailsElement = document.getElementById('response-tariff-comparison');

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        const response = await fetch('/api/test/tariff-comparison');
        const data = await response.json();

        if (!data.success) {
            outputElement.textContent = `Error: ${data.error}`;
            return;
        }

        // Format the comparison output
        let output = `=== TARIFF IMPLEMENTATION COMPARISON ===\n\n`;
        output += `Current Time: ${data.current_time}\n\n`;

        output += `--- IMPLEMENTATION NOTES ---\n`;
        output += `Actual: ${data.implementation_notes.actual}\n`;
        output += `No-Shift: ${data.implementation_notes.no_shift}\n`;
        output += `Difference: ${data.implementation_notes.difference}\n\n`;

        output += `--- PRICE COMPARISON (First 5 Periods) ---\n\n`;

        output += `YOUR IMPLEMENTATION (with 30-min shift):\n`;
        for (const [period, price] of Object.entries(data.comparison.actual_tariff_first_5_periods)) {
            output += `${period}: $${price.toFixed(4)}\n`;
        }

        output += `\nNO-SHIFT VERSION (direct mapping):\n`;
        for (const [period, price] of Object.entries(data.comparison.no_shift_first_5_periods)) {
            output += `${period}: $${price.toFixed(4)}\n`;
        }

        output += `\n\n--- RAW API DATA SAMPLES ---\n`;
        output += `(Check advancedPrice structure)\n\n`;
        output += JSON.stringify(data.raw_forecast_samples, null, 2);

        output += `\n\n--- KEY QUESTION ---\n`;
        output += `Is 'predicted' a simple number or an object with 'perKwh' field?\n`;
        output += `Check the raw_forecast_samples above.\n\n`;

        output += `If you see differences between YOUR and NO-SHIFT versions,\n`;
        output += `that's the 30-minute advance shift in action!\n`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function testRawEndpoint(event) {
    event.preventDefault();

    const endpoint = document.getElementById('raw-endpoint').value;
    const method = document.getElementById('raw-method').value;
    const outputElement = document.getElementById('output-raw');
    const detailsElement = document.getElementById('response-raw');

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        const response = await fetch('/api/test/amber/raw', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                endpoint: endpoint,
                method: method
            })
        });

        const data = await response.json();

        // Pretty print JSON with metadata
        let output = `Endpoint: ${data.endpoint || 'N/A'}\n`;
        output += `HTTP Status: ${data.status_code || response.status}\n`;
        output += `Success: ${data.success ? 'Yes' : 'No'}\n\n`;
        output += `Response:\n${JSON.stringify(data.data, null, 2)}`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}
</script>

<style>
pre {
    background-color: var(--card-background-color);
    padding: 1rem;
    border-radius: var(--border-radius);
    overflow-x: auto;
    max-height: 500px;
    overflow-y: auto;
}

code {
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
}

details {
    margin-top: 1rem;
}

article {
    margin-bottom: 2rem;
}

button {
    margin-bottom: 1rem;
}
</style>
{% endblock settings_content %}
