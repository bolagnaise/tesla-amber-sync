{% extends "settings_base.html" %}

{% block settings_content %}
<hgroup>
    <h1>API Testing & Monitoring</h1>
    <h2>Test API endpoints, view live data, and debug integrations</h2>
</hgroup>

<!-- Quick Stats Dashboard -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <article style="padding: 1rem; text-align: center;">
        <h4 style="margin: 0; font-size: 0.85em; color: var(--muted-color);">Current Price</h4>
        <p id="stat-current-price" style="margin: 0.5em 0; font-size: 1.8em; font-weight: bold;">--</p>
        <small id="stat-price-trend" style="color: var(--muted-color);">Loading...</small>
    </article>
    <article style="padding: 1rem; text-align: center;">
        <h4 style="margin: 0; font-size: 0.85em; color: var(--muted-color);">Renewables</h4>
        <p id="stat-renewables" style="margin: 0.5em 0; font-size: 1.8em; font-weight: bold;">--</p>
        <small style="color: var(--muted-color);">% Green Energy</small>
    </article>
    <article style="padding: 1rem; text-align: center;">
        <h4 style="margin: 0; font-size: 0.85em; color: var(--muted-color);">Next Hour Avg</h4>
        <p id="stat-next-hour" style="margin: 0.5em 0; font-size: 1.8em; font-weight: bold;">--</p>
        <small style="color: var(--muted-color);">¬¢/kWh</small>
    </article>
    <article style="padding: 1rem; text-align: center;">
        <h4 style="margin: 0; font-size: 0.85em; color: var(--muted-color);">24h Range</h4>
        <p id="stat-price-range" style="margin: 0.5em 0; font-size: 1.8em; font-weight: bold;">--</p>
        <small style="color: var(--muted-color);">Min - Max</small>
    </article>
</div>

<!-- API Connection Status -->
<article id="connection-status">
    <header><strong>Connection Status</strong></header>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div id="amber-status" style="padding: 1rem; border-radius: 0.5rem; background: rgba(150, 150, 150, 0.1);">
            <h4 style="margin: 0 0 0.5em 0;">‚ö° Amber Electric</h4>
            <div id="amber-status-content">
                <p style="margin: 0;">Checking connection...</p>
            </div>
        </div>
        <div id="tesla-status" style="padding: 1rem; border-radius: 0.5rem; background: rgba(150, 150, 150, 0.1);">
            <h4 style="margin: 0 0 0.5em 0;">üîã Tesla Energy</h4>
            <div id="tesla-status-content">
                <p style="margin: 0;">Checking connection...</p>
            </div>
        </div>
    </div>
    <button onclick="refreshStatus()" style="margin-top: 1rem; width: auto;" class="outline">Refresh Status</button>
</article>

<!-- Quick Actions -->
<article>
    <header><strong>Quick Actions</strong></header>
    <p style="font-size: 0.85em; margin-bottom: 1em;">Common scenarios and diagnostics at a glance</p>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button onclick="quickAction('current-situation')" class="contrast">üìä Current Situation</button>
        <button onclick="quickAction('next-24h-forecast')" class="contrast">üìà Next 24h Forecast</button>
        <button onclick="quickAction('optimal-times')" class="contrast">‚ö° Best Charge/Export Times</button>
        <button onclick="quickAction('tesla-battery')" class="contrast">üîã Battery Status</button>
        <button onclick="quickAction('tesla-tou')" class="contrast">‚è∞ Current TOU Schedule</button>
        <button onclick="quickAction('sync-test')" class="contrast">üîÑ Test Full Sync</button>
    </div>
    <div id="quick-action-result" style="margin-top: 1rem; display: none;">
        <details open>
            <summary id="quick-action-title">Results</summary>
            <div id="quick-action-content" style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                <pre id="quick-action-output" style="margin: 0; white-space: pre-wrap;"></pre>
            </div>
        </details>
    </div>
</article>

<!-- Tesla API Testing -->
<details>
    <summary><strong>üîã Tesla Energy API Endpoints</strong></summary>
    <div style="margin-top: 1rem;">
        <article>
            <h4>Site Info</h4>
            <button onclick="testTeslaEndpoint('site-info')" class="contrast">GET Site Information</button>
            <details id="response-tesla-site-info">
                <summary>Response</summary>
                <pre><code id="output-tesla-site-info">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>Live Status</h4>
            <button onclick="testTeslaEndpoint('live-status')" class="contrast">GET Live Battery & Power Status</button>
            <details id="response-tesla-live-status">
                <summary>Response</summary>
                <pre><code id="output-tesla-live-status">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>TOU Schedule</h4>
            <button onclick="testTeslaEndpoint('tou-schedule')" class="contrast">GET Current TOU Schedule</button>
            <details id="response-tesla-tou">
                <summary>Response</summary>
                <pre><code id="output-tesla-tou">Click the button to test this endpoint</code></pre>
            </details>
        </article>
    </div>
</details>

<!-- Amber API Testing -->
<details open>
    <summary><strong>‚ö° Amber Electric API Endpoints</strong></summary>
    <div style="margin-top: 1rem;">
        <article>
            <h4>Sites</h4>
            <button onclick="testEndpoint('sites')" class="contrast">GET /v1/sites</button>
            <details id="response-sites">
                <summary>Response</summary>
                <pre><code id="output-sites">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>Current Prices</h4>
            <button onclick="testEndpoint('current-prices')" class="contrast">GET /v1/sites/{site_id}/prices/current</button>
            <details id="response-current-prices">
                <summary>Response</summary>
                <pre><code id="output-current-prices">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article style="border: 2px solid var(--primary); background-color: var(--card-background-color);">
            <h4>‚≠ê Advanced Price Schema (30-min forecast with ML predictions)</h4>
            <p style="font-size: 0.85em;"><strong>This endpoint shows the <code>advancedPrice.predicted</code> field used in TOU tariff conversion.</strong></p>
            <button onclick="testAdvancedPriceSchema()" class="contrast">GET Price Forecast with Advanced Schema</button>
            <details id="response-advanced-price">
                <summary>Response (with Advanced Price breakdown)</summary>
                <pre><code id="output-advanced-price">Click the button to see the advanced price structure</code></pre>
            </details>
        </article>

        <article>
            <h4>Price Forecast (24 hours)</h4>
            <button onclick="testEndpoint('price-forecast', {next_hours: 24})" class="contrast">GET /v1/sites/{site_id}/prices</button>
            <details id="response-price-forecast">
                <summary>Response</summary>
                <pre><code id="output-price-forecast">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>Price Forecast (48 hours)</h4>
            <button onclick="testEndpoint('price-forecast-48h', {next_hours: 48})" class="contrast">GET /v1/sites/{site_id}/prices?next_hours=48</button>
            <details id="response-price-forecast-48h">
                <summary>Response</summary>
                <pre><code id="output-price-forecast-48h">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>Price Forecast (5-minute resolution)</h4>
            <button onclick="testEndpoint('price-forecast-5min', {next_hours: 24, resolution: 5})" class="contrast">GET /v1/sites/{site_id}/prices?resolution=5</button>
            <details id="response-price-forecast-5min">
                <summary>Response</summary>
                <pre><code id="output-price-forecast-5min">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>Price Forecast (30-minute resolution)</h4>
            <button onclick="testEndpoint('price-forecast-30min', {next_hours: 48, resolution: 30})" class="contrast">GET /v1/sites/{site_id}/prices?resolution=30</button>
            <details id="response-price-forecast-30min">
                <summary>Response</summary>
                <pre><code id="output-price-forecast-30min">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>Usage History (Last 7 days)</h4>
            <button onclick="testEndpoint('usage')" class="contrast">GET /v1/sites/{site_id}/usage</button>
            <details id="response-usage">
                <summary>Response</summary>
                <pre><code id="output-usage">Click the button to test this endpoint</code></pre>
            </details>
        </article>
    </div>
</details>

<!-- Tariff Implementation Comparison -->
<article style="border: 2px solid var(--del-color); background-color: var(--card-background-color);">
    <h3>üîç Tariff Implementation Comparison (Debug Price Differences)</h3>
    <p><strong>Debug and analyze your tariff implementation.</strong></p>
    <p>This shows:</p>
    <ul>
        <li>Your current implementation (with 30-min advance shift)</li>
        <li>Hypothetical "no-shift" version (direct price mapping)</li>
        <li>Raw API data structure (check if predicted is number or object)</li>
    </ul>
    <button onclick="testTariffComparison()" style="background-color: var(--del-color);">Compare Implementations</button>
    <details id="response-tariff-comparison">
        <summary>Comparison Results</summary>
        <pre><code id="output-tariff-comparison">Click the button to see the comparison</code></pre>
    </details>
</article>

<!-- Custom Raw API Call -->
<article>
    <h3>Custom Raw API Call</h3>
    <form id="raw-api-form" onsubmit="testRawEndpoint(event)">
        <label for="raw-endpoint">
            Endpoint Path
            <input type="text" id="raw-endpoint" name="endpoint" placeholder="/sites" value="/sites">
        </label>
        <label for="raw-method">
            HTTP Method
            <select id="raw-method" name="method">
                <option value="GET" selected>GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
            </select>
        </label>
        <button type="submit" class="contrast">Execute Custom Call</button>
    </form>
    <details id="response-raw">
        <summary>Response</summary>
        <pre><code id="output-raw">Submit the form to test a custom endpoint</code></pre>
    </details>
</article>

<script>
// Load initial data on page load
window.addEventListener('DOMContentLoaded', async () => {
    await refreshStatus();
    await loadQuickStats();
});

// Refresh connection status
async function refreshStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();

        // Update Amber status
        const amberDiv = document.getElementById('amber-status');
        const amberContent = document.getElementById('amber-status-content');
        if (data.amber && data.amber.connected) {
            amberDiv.style.background = 'rgba(0, 255, 0, 0.1)';
            amberContent.innerHTML = `
                <p style="margin: 0; color: var(--ins-color); font-weight: bold;">‚úì Connected</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">${data.amber.message}</p>
            `;
        } else {
            amberDiv.style.background = 'rgba(255, 0, 0, 0.1)';
            amberContent.innerHTML = `
                <p style="margin: 0; color: var(--del-color); font-weight: bold;">‚úó Not Connected</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">${data.amber.message || 'Not configured'}</p>
            `;
        }

        // Update Tesla status
        const teslaDiv = document.getElementById('tesla-status');
        const teslaContent = document.getElementById('tesla-status-content');
        if (data.tesla && data.tesla.connected) {
            teslaDiv.style.background = 'rgba(0, 255, 0, 0.1)';
            teslaContent.innerHTML = `
                <p style="margin: 0; color: var(--ins-color); font-weight: bold;">‚úì Connected</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">${data.tesla.message}</p>
            `;
        } else {
            teslaDiv.style.background = 'rgba(255, 0, 0, 0.1)';
            teslaContent.innerHTML = `
                <p style="margin: 0; color: var(--del-color); font-weight: bold;">‚úó Not Connected</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">${data.tesla.message || 'Not configured'}</p>
            `;
        }
    } catch (error) {
        console.error('Error checking connection:', error);
    }
}

// Load quick stats for dashboard
async function loadQuickStats() {
    try {
        const response = await fetch('/api/amber/current-price');
        const data = await response.json();

        if (data && data.length > 0) {
            const general = data.find(p => p.channelType === 'general');
            if (general) {
                // Current price
                document.getElementById('stat-current-price').textContent = `${general.perKwh.toFixed(2)}¬¢`;
                document.getElementById('stat-price-trend').textContent = general.spikeStatus || 'Normal';

                // Renewables
                if (general.renewables !== undefined) {
                    document.getElementById('stat-renewables').textContent = `${general.renewables}%`;
                }
            }
        }

        // Get forecast for next hour and 24h range
        const forecastResponse = await fetch('/api/test/amber/price-forecast?next_hours=24&resolution=30');
        const forecastData = await forecastResponse.json();

        if (forecastData && forecastData.data) {
            const prices = forecastData.data
                .filter(p => p.channelType === 'general')
                .map(p => p.perKwh);

            if (prices.length > 2) {
                // Next hour average (next 2x 30-min periods)
                const nextHourAvg = (prices[0] + prices[1]) / 2;
                document.getElementById('stat-next-hour').textContent = nextHourAvg.toFixed(2);

                // 24h range
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                document.getElementById('stat-price-range').textContent = `${min.toFixed(1)} - ${max.toFixed(1)}`;
            }
        }
    } catch (error) {
        console.error('Error loading quick stats:', error);
    }
}

// Quick Actions
async function quickAction(action) {
    const resultDiv = document.getElementById('quick-action-result');
    const titleElem = document.getElementById('quick-action-title');
    const outputElem = document.getElementById('quick-action-output');

    resultDiv.style.display = 'block';
    outputElem.textContent = 'Loading...';

    try {
        switch (action) {
            case 'current-situation':
                titleElem.textContent = 'üìä Current Situation';
                const currentResp = await fetch('/api/amber/current-price');
                const currentData = await currentResp.json();
                const general = currentData.find(p => p.channelType === 'general');
                const feedIn = currentData.find(p => p.channelType === 'feedIn');

                let output = '=== CURRENT ELECTRICITY SITUATION ===\n\n';
                if (general) {
                    output += `Import Price: ${general.perKwh.toFixed(2)}¬¢/kWh\n`;
                    output += `Spike Status: ${general.spikeStatus || 'Normal'}\n`;
                    output += `Renewables: ${general.renewables}%\n`;
                }
                if (feedIn) {
                    output += `\nExport Price: ${feedIn.perKwh.toFixed(2)}¬¢/kWh\n`;
                }
                outputElem.textContent = output;
                break;

            case 'next-24h-forecast':
                titleElem.textContent = 'üìà Next 24h Forecast';
                const forecastResp = await fetch('/api/test/amber/price-forecast?next_hours=24&resolution=30');
                const forecastData = await forecastResp.json();

                const prices = forecastData.data.filter(p => p.channelType === 'general');
                let forecastOutput = '=== NEXT 24 HOURS PRICE FORECAST ===\n\n';
                prices.slice(0, 10).forEach(p => {
                    forecastOutput += `${p.period}: ${p.perKwh.toFixed(2)}¬¢/kWh\n`;
                });
                forecastOutput += `\n... and ${prices.length - 10} more periods\n`;
                outputElem.textContent = forecastOutput;
                break;

            case 'optimal-times':
                titleElem.textContent = '‚ö° Best Charge/Export Times';
                const optResp = await fetch('/api/test/amber/price-forecast?next_hours=24&resolution=30');
                const optData = await optResp.json();

                const importPrices = optData.data.filter(p => p.channelType === 'general');
                const exportPrices = optData.data.filter(p => p.channelType === 'feedIn');

                const sortedImport = [...importPrices].sort((a, b) => a.perKwh - b.perKwh);
                const sortedExport = [...exportPrices].sort((a, b) => b.perKwh - a.perKwh);

                let optOutput = '=== OPTIMAL TIMES (Next 24h) ===\n\n';
                optOutput += 'Best Times to CHARGE (Cheapest Import):\n';
                sortedImport.slice(0, 5).forEach((p, i) => {
                    optOutput += `${i+1}. ${p.period}: ${p.perKwh.toFixed(2)}¬¢/kWh\n`;
                });

                optOutput += '\nBest Times to EXPORT (Highest Feed-In):\n';
                sortedExport.slice(0, 5).forEach((p, i) => {
                    optOutput += `${i+1}. ${p.period}: ${p.perKwh.toFixed(2)}¬¢/kWh\n`;
                });
                outputElem.textContent = optOutput;
                break;

            case 'tesla-battery':
                titleElem.textContent = 'üîã Battery Status';
                const batteryResp = await fetch('/api/tesla/status');
                const batteryData = await batteryResp.json();

                let batteryOutput = '=== TESLA BATTERY STATUS ===\n\n';
                if (batteryData.error) {
                    batteryOutput += `Error: ${batteryData.error}\n`;
                } else {
                    batteryOutput += JSON.stringify(batteryData, null, 2);
                }
                outputElem.textContent = batteryOutput;
                break;

            case 'tesla-tou':
                titleElem.textContent = '‚è∞ Current TOU Schedule';
                const touResp = await fetch('/api/tou-schedule');
                const touData = await touResp.json();

                let touOutput = '=== CURRENT TOU SCHEDULE ON TESLA ===\n\n';
                touOutput += JSON.stringify(touData, null, 2);
                outputElem.textContent = touOutput;
                break;

            case 'sync-test':
                titleElem.textContent = 'üîÑ Full Sync Test';
                outputElem.textContent = 'Full sync test not implemented yet.\nThis would test the complete Amber‚ÜíTesla sync flow.';
                break;

            default:
                outputElem.textContent = 'Unknown action';
        }
    } catch (error) {
        outputElem.textContent = `Error: ${error.message}`;
    }
}

// Tesla API Endpoints
async function testTeslaEndpoint(name) {
    const outputElement = document.getElementById(`output-tesla-${name}`);
    const detailsElement = document.getElementById(`response-tesla-${name}`);

    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        let url;
        switch (name) {
            case 'site-info':
                url = '/api/tesla/status';
                break;
            case 'live-status':
                url = '/api/tesla/status';
                break;
            case 'tou-schedule':
                url = '/api/tou-schedule';
                break;
            default:
                throw new Error('Unknown Tesla endpoint');
        }

        const response = await fetch(url);
        const data = await response.json();

        outputElement.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

// Amber API Endpoints
async function testEndpoint(name, params = {}) {
    const outputElement = document.getElementById(`output-${name}`);
    const detailsElement = document.getElementById(`response-${name}`);

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        let url;
        switch (name) {
            case 'sites':
                url = '/api/test/amber/sites';
                break;
            case 'current-prices':
                url = '/api/test/amber/current-prices';
                break;
            case 'price-forecast':
            case 'price-forecast-48h':
            case 'price-forecast-5min':
            case 'price-forecast-30min':
                const queryParams = new URLSearchParams(params).toString();
                url = `/api/test/amber/price-forecast?${queryParams}`;
                break;
            case 'usage':
                url = '/api/test/amber/usage';
                break;
            default:
                throw new Error('Unknown endpoint');
        }

        const response = await fetch(url);
        const data = await response.json();

        // Pretty print JSON with metadata
        let output = `Endpoint: ${data.endpoint || 'N/A'}\n`;
        if (data.count !== undefined) {
            output += `Count: ${data.count} records\n`;
        }
        output += `Status: ${response.status}\n\n`;
        output += `Response:\n${JSON.stringify(data.data, null, 2)}`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function testAdvancedPriceSchema() {
    const outputElement = document.getElementById('output-advanced-price');
    const detailsElement = document.getElementById('response-advanced-price');

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        // Fetch 30-minute forecast data which includes advanced price schema
        const response = await fetch('/api/test/amber/advanced-price-schema');
        const data = await response.json();

        if (!data.success) {
            outputElement.textContent = `Error: ${data.error}`;
            return;
        }

        // Format the output to highlight the advanced price structure
        let output = `Endpoint: ${data.endpoint}\n`;
        output += `Records: ${data.count}\n`;
        output += `Status: ${response.status}\n\n`;

        output += `=== ADVANCED PRICE STRUCTURE ===\n\n`;

        if (data.sample) {
            output += `Sample Record (First 30-min interval):\n`;
            output += `Period: ${data.sample.period}\n`;
            output += `Channel Type: ${data.sample.channelType}\n`;
            output += `Spike Status: ${data.sample.spikeStatus}\n\n`;

            output += `--- Base Price Fields ---\n`;
            output += `per_kwh: ${data.sample.perKwh} c/kWh\n`;
            output += `spot_per_kwh: ${data.sample.spotPerKwh} c/kWh\n\n`;

            if (data.sample.advancedPrice) {
                output += `--- Advanced Price Object (ML Forecast) ---\n`;
                output += JSON.stringify(data.sample.advancedPrice, null, 2);
                output += `\n\n`;
                output += `Key Fields Explained:\n`;
                output += `‚Ä¢ predicted: ML-predicted price (used by SmartShift)\n`;
                output += `‚Ä¢ actual: Actual measured price (null for future intervals)\n`;
                output += `‚Ä¢ renewables: Percentage of renewable energy\n`;
                output += `‚Ä¢ channelType: 'general' (import) or 'feedIn' (export)\n`;
            }
        }

        output += `\n\n=== FULL API RESPONSE (ALL RECORDS) ===\n\n`;
        output += JSON.stringify(data.data, null, 2);

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function findTeslaSites() {
    const outputElement = document.getElementById('output-find-sites');
    const detailsElement = document.getElementById('response-find-sites');

    // Show loading state
    outputElement.textContent = 'Loading... (Connecting to Tesla via Teslemetry)';
    detailsElement.open = true;

    try {
        const response = await fetch('/api/test/find-tesla-sites');
        const data = await response.json();

        if (!data.success) {
            let output = `Error: ${data.error}\n\n`;
            if (data.help) {
                output += `Help: ${data.help}\n`;
            }
            outputElement.textContent = output;
            return;
        }

        // Format the output
        let output = `=== TESLA SITES FOUND ===\n\n`;
        output += `${data.instructions}\n\n`;

        for (const site of data.sites) {
            output += `Site Name: ${site.site_name}\n`;
            output += `Site ID: ${site.site_id} ‚Üê COPY THIS!\n`;
            output += `Type: ${site.resource_type}\n`;
            output += `\n`;
        }

        output += `\nNEXT STEPS:\n`;
        output += `1. Copy the Site ID above\n`;
        output += `2. Go to Settings (navigation menu)\n`;
        output += `3. Paste it into "Tesla Site ID" field\n`;
        output += `4. Click Save\n`;
        output += `5. Come back here and click "Compare Live Schedules"\n`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function testTariffComparison() {
    const outputElement = document.getElementById('output-tariff-comparison');
    const detailsElement = document.getElementById('response-tariff-comparison');

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        const response = await fetch('/api/test/tariff-comparison');
        const data = await response.json();

        if (!data.success) {
            outputElement.textContent = `Error: ${data.error}`;
            return;
        }

        // Format the comparison output
        let output = `=== TARIFF IMPLEMENTATION COMPARISON ===\n\n`;
        output += `Current Time: ${data.current_time}\n\n`;

        output += `--- IMPLEMENTATION NOTES ---\n`;
        output += `Actual: ${data.implementation_notes.actual}\n`;
        output += `No-Shift: ${data.implementation_notes.no_shift}\n`;
        output += `Difference: ${data.implementation_notes.difference}\n\n`;

        output += `--- PRICE COMPARISON (First 5 Periods) ---\n\n`;

        output += `YOUR IMPLEMENTATION (with 30-min shift):\n`;
        for (const [period, price] of Object.entries(data.comparison.actual_tariff_first_5_periods)) {
            output += `${period}: $${price.toFixed(4)}\n`;
        }

        output += `\nNO-SHIFT VERSION (direct mapping):\n`;
        for (const [period, price] of Object.entries(data.comparison.no_shift_first_5_periods)) {
            output += `${period}: $${price.toFixed(4)}\n`;
        }

        output += `\n\n--- RAW API DATA SAMPLES ---\n`;
        output += `(Check advancedPrice structure)\n\n`;
        output += JSON.stringify(data.raw_forecast_samples, null, 2);

        output += `\n\n--- KEY QUESTION ---\n`;
        output += `Is 'predicted' a simple number or an object with 'perKwh' field?\n`;
        output += `Check the raw_forecast_samples above.\n\n`;

        output += `If you see differences between YOUR and NO-SHIFT versions,\n`;
        output += `that's the 30-minute advance shift in action!\n`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function testRawEndpoint(event) {
    event.preventDefault();

    const endpoint = document.getElementById('raw-endpoint').value;
    const method = document.getElementById('raw-method').value;
    const outputElement = document.getElementById('output-raw');
    const detailsElement = document.getElementById('response-raw');

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        const response = await fetch('/api/test/amber/raw', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                endpoint: endpoint,
                method: method
            })
        });

        const data = await response.json();

        // Pretty print JSON with metadata
        let output = `Endpoint: ${data.endpoint || 'N/A'}\n`;
        output += `HTTP Status: ${data.status_code || response.status}\n`;
        output += `Success: ${data.success ? 'Yes' : 'No'}\n\n`;
        output += `Response:\n${JSON.stringify(data.data, null, 2)}`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}
</script>

<style>
pre {
    background-color: var(--card-background-color);
    padding: 1rem;
    border-radius: var(--border-radius);
    overflow-x: auto;
    max-height: 500px;
    overflow-y: auto;
}

code {
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
}

details {
    margin-top: 1rem;
}

article {
    margin-bottom: 2rem;
}

button {
    margin-bottom: 1rem;
}
</style>
{% endblock settings_content %}
