version: '3.8'

services:
  web:
    build: .
    container_name: tesla-sync
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      # Flask Configuration
      - SECRET_KEY=${SECRET_KEY:-please-change-this-to-a-random-string}
      - FLASK_RUN_PORT=5001

      # Database (SQLite stored in volume)
      - DATABASE_URL=${DATABASE_URL:-sqlite:////app/data/app.db}

      # Encryption Key - Auto-generated if not provided (recommended for ease of use)
      # Set this only if you want to use a specific key (e.g., for migrating from another instance)
      - FERNET_ENCRYPTION_KEY=${FERNET_ENCRYPTION_KEY:-}

      # Tesla API Credentials (Optional - can be configured via web UI)
      - TESLA_CLIENT_ID=${TESLA_CLIENT_ID:-}
      - TESLA_CLIENT_SECRET=${TESLA_CLIENT_SECRET:-}
      - TESLA_REDIRECT_URI=${TESLA_REDIRECT_URI:-}
      - APP_DOMAIN=${APP_DOMAIN:-}

    volumes:
      # ⚠️ IMPORTANT: This directory persists your database across container restarts
      # Before first run: mkdir -p ./data
      # For Unraid: Use /mnt/user/appdata/tesla-sync/data:/app/data
      # See DATABASE.md for backup and restore instructions
      - ./data:/app/data

    networks:
      - tesla-sync-network

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5001/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  tesla-sync-network:
    driver: bridge

volumes:
  data:
